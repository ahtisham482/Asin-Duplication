<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Amazon Keyword Performance Calculator</title>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/PapaParse/5.4.1/papaparse.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>
    <style>
        /* ============================================
           DESIGN SYSTEM TOKENS
           ============================================ */
        :root {
            /* Typography */
            --font-family: 'Inter', -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
            --font-size-xs: 11px;
            --font-size-sm: 13px;
            --font-size-base: 15px;
            --font-size-lg: 17px;
            --font-size-xl: 20px;
            --font-size-2xl: 26px;
            --font-size-3xl: 32px;
            --line-height-tight: 1.25;
            --line-height-normal: 1.5;
            --line-height-relaxed: 1.65;
            --font-weight-normal: 400;
            --font-weight-medium: 500;
            --font-weight-semibold: 600;
            --font-weight-bold: 700;

            /* Colors - Neutrals */
            --color-bg-base: #f9fafb;
            --color-bg-surface: #ffffff;
            --color-bg-muted: #f9fafb;
            --color-bg-subtle: #f3f4f6;
            --color-border-light: #e5e7eb;
            --color-border-default: #d1d5db;
            --color-border-strong: #9ca3af;
            --color-text-primary: #1f2937;
            --color-text-secondary: #4b5563;
            --color-text-muted: #6b7280;
            --color-text-disabled: #9ca3af;

            /* Colors - Semantic (VIBRANT ORIGINAL VALUES) */
            --color-primary: #2563eb;
            --color-primary-hover: #1d4ed8;
            --color-primary-active: #1e40af;
            --color-primary-bg: #eff6ff;
            --color-primary-border: #bfdbfe;
            --color-primary-text: #1e40af;

            --color-success: #16a34a;
            --color-success-hover: #15803d;
            --color-success-bg: #f0fdf4;
            --color-success-border: #bbf7d0;
            --color-success-text: #16a34a;

            --color-warning: #d97706;
            --color-warning-hover: #b45309;
            --color-warning-bg: #fef3c7;
            --color-warning-border: #fcd34d;
            --color-warning-text: #92400e;

            --color-danger: #dc2626;
            --color-danger-hover: #b91c1c;
            --color-danger-bg: #fef2f2;
            --color-danger-border: #fecaca;
            --color-danger-text: #dc2626;

            --color-info: #1e40af;
            --color-info-bg: #f0f9ff;
            --color-info-border: #bfdbfe;
            --color-info-text: #1e40af;

            /* Spacing Scale (4px base) */
            --space-1: 4px;
            --space-2: 8px;
            --space-3: 12px;
            --space-4: 16px;
            --space-5: 20px;
            --space-6: 24px;
            --space-8: 32px;
            --space-10: 40px;
            --space-12: 48px;

            /* Border Radius */
            --radius-sm: 4px;
            --radius-md: 6px;
            --radius-lg: 8px;
            --radius-xl: 12px;

            /* Shadows */
            --shadow-sm: 0 1px 2px 0 rgba(0, 0, 0, 0.05);
            --shadow-md: 0 4px 6px -1px rgba(0, 0, 0, 0.1), 0 2px 4px -2px rgba(0, 0, 0, 0.1);
            --shadow-lg: 0 10px 15px -3px rgba(0, 0, 0, 0.1), 0 4px 6px -4px rgba(0, 0, 0, 0.1);

            /* Transitions */
            --transition-fast: 150ms ease;
            --transition-normal: 200ms ease;
        }

        /* Load Inter font */
        @import url('https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap');

        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: var(--font-family);
            font-size: var(--font-size-base);
            background-color: var(--color-bg-base);
            color: var(--color-text-primary);
            line-height: var(--line-height-relaxed);
            -webkit-font-smoothing: antialiased;
            -moz-osx-font-smoothing: grayscale;
        }

        .container {
            max-width: 1400px;
            margin: 0 auto;
            padding: var(--space-6);
        }

        .card {
            background: var(--color-bg-surface);
            border-radius: var(--radius-xl);
            box-shadow: var(--shadow-md);
            padding: var(--space-6);
            margin-bottom: var(--space-6);
            border: 1px solid var(--color-border-light);
        }

        .header {
            display: flex;
            align-items: center;
            gap: var(--space-3);
            margin-bottom: var(--space-6);
            padding-bottom: var(--space-4);
            border-bottom: 1px solid var(--color-border-light);
        }

        .header h1 {
            font-size: var(--font-size-2xl);
            font-weight: var(--font-weight-bold);
            color: var(--color-text-primary);
            letter-spacing: -0.02em;
            line-height: var(--line-height-tight);
        }

        .icon {
            width: 36px;
            height: 36px;
            color: var(--color-primary);
            flex-shrink: 0;
        }

        .loading-overlay {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background-color: rgba(15, 23, 42, 0.6);
            backdrop-filter: blur(4px);
            display: flex;
            justify-content: center;
            align-items: center;
            z-index: 1000;
        }

        .loading-content {
            background: var(--color-bg-surface);
            padding: var(--space-8);
            border-radius: var(--radius-xl);
            text-align: center;
            max-width: 420px;
            box-shadow: var(--shadow-lg);
        }

        .loading-content h3 {
            font-size: var(--font-size-lg);
            font-weight: var(--font-weight-semibold);
            color: var(--color-text-primary);
            margin-bottom: var(--space-2);
        }

        .loading-content p {
            font-size: var(--font-size-sm);
            color: var(--color-text-secondary);
        }

        .loading-spinner {
            width: 44px;
            height: 44px;
            border: 3px solid var(--color-border-light);
            border-top: 3px solid var(--color-primary);
            border-radius: 50%;
            animation: spin 0.8s linear infinite;
            margin: 0 auto var(--space-4);
        }

        @keyframes spin {
            0% {
                transform: rotate(0deg);
            }

            100% {
                transform: rotate(360deg);
            }
        }

        .progress-bar {
            width: 100%;
            height: 6px;
            background-color: var(--color-bg-muted);
            border-radius: var(--radius-sm);
            margin: var(--space-4) 0;
            overflow: hidden;
        }

        .progress-fill {
            height: 100%;
            background: linear-gradient(90deg, var(--color-primary), #3b82f6);
            border-radius: var(--radius-sm);
            transition: width 0.3s ease;
        }

        .summary-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(220px, 1fr));
            gap: var(--space-4);
            margin-bottom: var(--space-6);
        }

        .summary-card {
            padding: var(--space-4) var(--space-5);
            border-radius: var(--radius-lg);
            display: flex;
            justify-content: space-between;
            align-items: center;
            border: 1px solid transparent;
            transition: transform var(--transition-fast), box-shadow var(--transition-fast);
        }

        .summary-card:hover {
            transform: translateY(-2px);
            box-shadow: var(--shadow-sm);
        }

        .summary-card.blue {
            background-color: #eff6ff;
        }

        .summary-card.orange {
            background-color: #fff7ed;
        }

        .summary-card.red {
            background-color: #fef2f2;
        }

        .summary-card.green {
            background-color: #f0fdf4;
        }

        .summary-content {
            flex: 1;
        }

        .summary-label {
            font-size: 14px;
            font-weight: 500;
            margin-bottom: 4px;
        }

        .summary-value {
            font-size: var(--font-size-2xl);
            font-weight: var(--font-weight-bold);
            line-height: var(--line-height-tight);
        }

        .blue .summary-label,
        .blue .summary-value {
            color: #1d4ed8;
        }

        .orange .summary-label,
        .orange .summary-value {
            color: #ea580c;
        }

        .red .summary-label,
        .red .summary-value {
            color: #dc2626;
        }

        .green .summary-label,
        .green .summary-value {
            color: #16a34a;
        }

        .upload-section {
            background-color: var(--color-primary-bg);
            border: 1px solid var(--color-primary-border);
            border-radius: var(--radius-lg);
            padding: var(--space-5);
            margin-bottom: var(--space-5);
        }

        .upload-header {
            display: flex;
            align-items: center;
            gap: var(--space-3);
            margin-bottom: var(--space-3);
        }

        .upload-header h3 {
            font-size: var(--font-size-lg);
            font-weight: var(--font-weight-semibold);
            color: var(--color-primary-text);
        }

        .file-input {
            display: block;
            width: 100%;
            padding: var(--space-2) 0;
            font-size: var(--font-size-sm);
            color: var(--color-text-secondary);
            cursor: pointer;
        }

        .file-input::file-selector-button {
            padding: var(--space-2) var(--space-4);
            border: 1px solid var(--color-border-default);
            border-radius: var(--radius-md);
            background-color: var(--color-bg-surface);
            color: var(--color-text-primary);
            font-size: var(--font-size-sm);
            font-weight: var(--font-weight-medium);
            cursor: pointer;
            margin-right: var(--space-3);
            transition: all var(--transition-fast);
        }

        .file-input::file-selector-button:hover {
            background-color: var(--color-bg-muted);
            border-color: var(--color-border-strong);
        }

        .column-mapping {
            margin-top: var(--space-3);
            padding: var(--space-4);
            background-color: var(--color-info-bg);
            border-radius: var(--radius-md);
            border: 1px solid var(--color-info-border);
            display: none;
        }

        .mapping-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(180px, 1fr));
            gap: var(--space-3);
            margin-top: var(--space-2);
        }

        .weights-section {
            background-color: var(--color-bg-muted);
            border-radius: var(--radius-lg);
            padding: var(--space-5);
            margin-bottom: var(--space-6);
            border: 1px solid var(--color-border-light);
        }

        .weights-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(180px, 1fr));
            gap: var(--space-4);
        }

        .weight-input,
        .mapping-select,
        .filter-input,
        .control-input {
            width: 100%;
            height: 40px;
            padding: var(--space-2) var(--space-3);
            border: 1px solid var(--color-border-default);
            border-radius: var(--radius-md);
            font-size: var(--font-size-sm);
            font-family: var(--font-family);
            background-color: var(--color-bg-surface);
            color: var(--color-text-primary);
            transition: all var(--transition-fast);
        }

        .weight-input:hover,
        .mapping-select:hover,
        .filter-input:hover,
        .control-input:hover {
            border-color: var(--color-border-strong);
        }

        .weight-input:focus,
        .mapping-select:focus,
        .filter-input:focus,
        .control-input:focus {
            outline: none;
            border-color: var(--color-primary);
            box-shadow: 0 0 0 3px rgba(37, 99, 235, 0.15);
        }

        .weight-input:disabled,
        .mapping-select:disabled,
        .control-input:disabled {
            background-color: var(--color-bg-muted);
            color: var(--color-text-disabled);
            cursor: not-allowed;
        }

        .recommendations {
            background-color: var(--color-warning-bg);
            border: 1px solid var(--color-warning-border);
            border-radius: var(--radius-lg);
            padding: var(--space-6);
            margin-bottom: var(--space-6);
        }

        .recommendation-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(280px, 1fr));
            gap: var(--space-4);
        }

        .keep-section {
            background-color: var(--color-success-bg);
            border: 1px solid var(--color-success-border);
            border-radius: var(--radius-md);
            padding: var(--space-4);
        }

        .remove-section {
            background-color: var(--color-danger-bg);
            border: 1px solid var(--color-danger-border);
            border-radius: var(--radius-md);
            padding: var(--space-4);
        }

        .collapsible-section {
            border: 1px solid var(--color-border-light);
            border-radius: var(--radius-lg);
            margin-bottom: var(--space-4);
            overflow: hidden;
            background-color: var(--color-bg-surface);
            box-shadow: var(--shadow-sm);
            transition: box-shadow var(--transition-fast);
        }

        .collapsible-section:hover {
            box-shadow: var(--shadow-md);
        }

        .collapsible-header {
            background-color: var(--color-bg-muted);
            padding: var(--space-3) var(--space-4);
            cursor: pointer;
            display: flex;
            justify-content: space-between;
            align-items: center;
            font-weight: var(--font-weight-semibold);
            font-size: var(--font-size-sm);
            transition: background-color var(--transition-fast);
            user-select: none;
        }

        .collapsible-header:hover {
            background-color: var(--color-bg-subtle);
        }

        .collapsible-content {
            padding: var(--space-4);
            display: none;
            border-top: 1px solid var(--color-border-light);
        }

        .collapsible-content.expanded {
            display: block;
        }

        .dropdown-arrow {
            transition: transform var(--transition-fast);
            color: var(--color-text-muted);
        }

        .dropdown-arrow.rotated {
            transform: rotate(180deg);
        }

        .analysis-control-panel {
            background-color: var(--color-bg-surface);
            padding: var(--space-4);
            border-radius: var(--radius-lg);
            margin-bottom: var(--space-4);
            border: 1px solid var(--color-border-light);
        }

        .control-row {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(150px, 1fr));
            gap: var(--space-4);
            align-items: end;
        }

        .control-group {
            display: flex;
            flex-direction: column;
            gap: var(--space-1);
        }

        .control-label {
            font-size: 12px;
            font-weight: 500;
            color: #4b5563;
        }

        .quick-stats-bar {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(140px, 1fr));
            gap: var(--space-3);
            margin-top: var(--space-4);
            padding-top: var(--space-4);
            border-top: 1px solid var(--color-border-light);
        }

        .quick-stat {
            background-color: var(--color-bg-surface);
            padding: var(--space-3);
            border-radius: var(--radius-md);
            text-align: center;
            border: 1px solid var(--color-border-light);
        }

        .stat-value {
            font-size: var(--font-size-xl);
            font-weight: var(--font-weight-bold);
            color: var(--color-text-primary);
            display: block;
            line-height: var(--line-height-tight);
        }

        .stat-label {
            font-size: var(--font-size-xs);
            color: var(--color-text-muted);
            margin-top: var(--space-1);
        }

        .table-container {
            overflow-x: auto;
            margin-bottom: var(--space-6);
            max-height: 600px;
            overflow-y: auto;
            border-radius: var(--radius-lg);
            border: 1px solid var(--color-border-light);
        }

        .table-filters {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(140px, 1fr));
            gap: var(--space-2);
            margin-bottom: var(--space-3);
            padding: var(--space-3);
            background-color: var(--color-bg-muted);
            border-radius: var(--radius-md);
        }

        .pagination-controls {
            display: flex;
            justify-content: space-between;
            align-items: center;
            flex-wrap: wrap;
            gap: var(--space-3);
            margin: var(--space-4) 0;
            padding: var(--space-3) var(--space-4);
            background-color: var(--color-bg-muted);
            border-radius: var(--radius-md);
            font-size: var(--font-size-sm);
        }

        table {
            width: 100%;
            border-collapse: collapse;
            font-size: var(--font-size-sm);
        }

        th,
        td {
            border: 1px solid var(--color-border-light);
            padding: var(--space-2) var(--space-3);
            text-align: left;
            vertical-align: middle;
        }

        th {
            background-color: #f9fafb;
            font-weight: 600;
            font-size: 14px;
            position: sticky;
            top: 0;
            z-index: 10;
        }

        tr:hover td {
            background-color: var(--color-bg-base);
        }

        td input,
        td select {
            width: 100%;
            padding: var(--space-1) var(--space-2);
            border: 1px solid var(--color-border-light);
            border-radius: var(--radius-sm);
            font-size: var(--font-size-sm);
            font-family: var(--font-family);
        }

        .duplicate-row {
            background-color: var(--color-warning-bg);
        }

        .btn {
            display: inline-flex;
            align-items: center;
            justify-content: center;
            gap: var(--space-2);
            padding: var(--space-2) var(--space-4);
            min-height: 40px;
            border: none;
            border-radius: var(--radius-md);
            font-size: var(--font-size-sm);
            font-weight: var(--font-weight-semibold);
            font-family: var(--font-family);
            cursor: pointer;
            transition: all var(--transition-fast);
            text-decoration: none;
            white-space: nowrap;
        }

        .btn:focus-visible {
            outline: 2px solid var(--color-primary);
            outline-offset: 2px;
        }

        .btn:disabled {
            opacity: 0.5;
            cursor: not-allowed;
            pointer-events: none;
        }

        .btn-primary {
            background-color: var(--color-primary);
            color: white;
            box-shadow: 0 1px 2px rgba(37, 99, 235, 0.2);
        }

        .btn-primary:hover {
            background-color: var(--color-primary-hover);
            transform: translateY(-1px);
            box-shadow: 0 2px 4px rgba(37, 99, 235, 0.3);
        }

        .btn-primary:active {
            background-color: var(--color-primary-active);
            transform: translateY(0);
        }

        .btn-danger {
            background-color: var(--color-danger);
            color: white;
            padding: var(--space-1) var(--space-2);
            min-height: 32px;
            font-size: var(--font-size-xs);
        }

        .btn-danger:hover {
            background-color: var(--color-danger-hover);
            transform: translateY(-1px);
        }

        .btn-secondary {
            background-color: var(--color-bg-muted);
            color: var(--color-text-secondary);
            border: 1px solid var(--color-border-default);
            padding: var(--space-1) var(--space-3);
            min-height: 32px;
            font-size: var(--font-size-xs);
        }

        .btn-secondary:hover {
            background-color: var(--color-bg-subtle);
            border-color: var(--color-border-strong);
            color: var(--color-text-primary);
        }

        .btn-success {
            background-color: var(--color-success);
            color: white;
            box-shadow: 0 1px 2px rgba(22, 163, 74, 0.2);
        }

        .btn-success:hover {
            background-color: var(--color-success-hover);
            transform: translateY(-1px);
            box-shadow: 0 2px 4px rgba(22, 163, 74, 0.3);
        }

        .btn-warning {
            background-color: var(--color-warning);
            color: white;
            box-shadow: 0 1px 2px rgba(217, 119, 6, 0.2);
        }

        .btn-warning:hover {
            background-color: var(--color-warning-hover);
            transform: translateY(-1px);
            box-shadow: 0 2px 4px rgba(217, 119, 6, 0.3);
        }

        .action-badge {
            display: inline-block;
            padding: var(--space-1) var(--space-2);
            border-radius: var(--radius-xl);
            font-size: var(--font-size-xs);
            font-weight: var(--font-weight-medium);
            text-align: center;
            line-height: var(--line-height-normal);
        }

        .action-elite {
            background-color: var(--color-success-bg);
            color: var(--color-success);
            border: 1px solid var(--color-success-border);
        }

        .action-strong {
            background-color: var(--color-primary-bg);
            color: var(--color-primary);
            border: 1px solid var(--color-primary-border);
        }

        .action-weak {
            background-color: var(--color-warning-bg);
            color: var(--color-warning);
            border: 1px solid var(--color-warning-border);
        }

        .action-remove {
            background-color: var(--color-danger-bg);
            color: var(--color-danger);
            border: 1px solid var(--color-danger-border);
        }

        .section-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: var(--space-4);
        }

        .section-title {
            font-size: var(--font-size-lg);
            font-weight: var(--font-weight-semibold);
            color: var(--color-text-primary);
        }

        .alert {
            padding: var(--space-3) var(--space-4);
            border-radius: var(--radius-md);
            margin-bottom: var(--space-4);
            font-size: var(--font-size-sm);
        }

        .alert-warning {
            background-color: var(--color-warning-bg);
            border: 1px solid var(--color-warning-border);
            color: var(--color-warning-text);
        }

        .text-small {
            font-size: var(--font-size-xs);
            color: var(--color-text-muted);
            line-height: var(--line-height-normal);
        }

        .metrics-details {
            font-size: var(--font-size-xs);
            color: var(--color-text-secondary);
            margin-top: var(--space-2);
            line-height: var(--line-height-relaxed);
        }

        .font-bold {
            font-weight: var(--font-weight-bold);
        }

        .text-center {
            text-align: center;
        }

        .hidden {
            display: none;
        }

        .file-stats {
            margin-top: var(--space-2);
            padding: var(--space-3);
            background-color: var(--color-info-bg);
            border: 1px solid var(--color-info-border);
            border-radius: var(--radius-md);
            font-size: var(--font-size-sm);
            color: var(--color-info-text);
            line-height: var(--line-height-relaxed);
        }
    </style>
</head>

<body>
    <div id="loadingOverlay" class="loading-overlay hidden">
        <div class="loading-content">
            <div class="loading-spinner"></div>
            <h3 id="loadingTitle">Processing Data...</h3>
            <p id="loadingMessage">Please wait while we process your file</p>
            <div class="progress-bar">
                <div id="progressFill" class="progress-fill" style="width: 0%"></div>
            </div>
            <p id="loadingDetails" class="text-small">Starting...</p>
        </div>
    </div>

    <div class="container">
        <div class="card">
            <div class="header">
                <svg class="icon" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2"
                        d="M9 7h6m0 10v-3m-3 3h.01M9 17h.01M9 14h.01M12 14h.01M15 11h.01M12 11h.01M9 11h.01M7 21h10a2 2 0 002-2V5a2 2 0 00-2 2v14a2 2 0 002 2z">
                    </path>
                </svg>
                <h1>Amazon Keyword Consolidation & Performance Calculator</h1>
            </div>

            <!-- Bulk File Upload Section -->
            <div class="upload-section" style="background-color: #fef3c7; border-color: #fcd34d;">
                <div class="upload-header">
                    <svg width="20" height="20" fill="none" stroke="#d97706" viewBox="0 0 24 24">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2"
                            d="M9 12h6m-6 4h6m2 5H7a2 2 0 01-2-2V5a2 2 0 012-2h5.586a1 1 0 01.707.293l5.414 5.414a1 1 0 01.293.707V19a2 2 0 01-2 2z">
                        </path>
                    </svg>
                    <h3 style="color: #92400e;">Upload Amazon Bulk File (Required for Export)</h3>
                </div>
                <input type="file" id="bulkFileInput" accept=".xlsx" class="file-input">
                <div class="text-small" style="margin-top: 8px; color: #92400e;">
                    Upload Amazon Advertising bulk file (.xlsx) to enable bulk export. Contains Campaign ID, Ad Group
                    ID, Keyword ID needed for pausing. <strong>You can also process duplicates using only this
                        file.</strong>
                </div>
                <div id="bulkFileStats" class="file-stats hidden" style="background-color: #fef9c3;"></div>
                <button id="processBulkOnlyBtn" class="btn btn-warning" style="margin-top: 12px; display: none;">
                    Process Bulk File Only (Skip Scale Insights)
                </button>
            </div>

            <!-- Scale Insights CSV Upload Section -->
            <div class="upload-section">
                <div class="upload-header">
                    <svg width="20" height="20" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2"
                            d="M7 16a4 4 0 01-.88-7.903A5 5 0 1115.9 6L16 6a5 5 0 011 9.9M15 13l-3-3m0 0l-3 3m3-3v12">
                        </path>
                    </svg>
                    <h3>Upload Scale Insights Keyword Data</h3>
                </div>
                <input type="file" id="fileInput" accept=".csv,.xlsx" class="file-input">
                <div class="text-small" style="margin-top: 8px;">
                    Expected columns: Campaign Name, Keyword, Sales, Conversion, ACOS, Orders, ASIN, Campaign Status,
                    Keyword Status
                </div>
                <div id="fileStats" class="file-stats hidden"></div>

                <div id="columnMapping" class="column-mapping">
                    <h4 style="margin-bottom: 8px; font-weight: 600;">Map Your Columns:</h4>
                    <div class="mapping-grid">
                        <div><label class="text-small font-bold">Campaign Name:</label><select id="campaignColumnSelect"
                                class="mapping-select">
                                <option value="">Select</option>
                            </select></div>
                        <div><label class="text-small font-bold">Keyword:</label><select id="keywordColumnSelect"
                                class="mapping-select">
                                <option value="">Select</option>
                            </select></div>
                        <div><label class="text-small font-bold">ASIN:</label><select id="asinColumnSelect"
                                class="mapping-select">
                                <option value="">Select</option>
                            </select></div>
                        <div><label class="text-small font-bold">Sales:</label><select id="salesColumnSelect"
                                class="mapping-select">
                                <option value="">Select</option>
                            </select></div>
                        <div><label class="text-small font-bold">Orders:</label><select id="ordersColumnSelect"
                                class="mapping-select">
                                <option value="">Select</option>
                            </select></div>
                        <div><label class="text-small font-bold">Conversion Rate:</label><select
                                id="conversionColumnSelect" class="mapping-select">
                                <option value="">Select</option>
                            </select></div>
                        <div><label class="text-small font-bold">ACOS:</label><select id="acosColumnSelect"
                                class="mapping-select">
                                <option value="">Select</option>
                            </select></div>
                        <div><label class="text-small font-bold">Campaign Status:</label><select
                                id="campaignStatusColumnSelect" class="mapping-select">
                                <option value="">Select</option>
                            </select></div>
                        <div><label class="text-small font-bold">Keyword Status:</label><select
                                id="keywordStatusColumnSelect" class="mapping-select">
                                <option value="">Select</option>
                            </select></div>
                        <div style="display: flex; align-items: end;">
                            <button id="applyMappingBtn" class="btn btn-primary">Apply Mapping</button>
                        </div>
                    </div>
                </div>

                <!-- Zero Sales Keywords Section -->
                <div id="zeroSalesSection" style="margin-top: 20px; display: none;">
                    <div class="collapsible-section">
                        <div class="collapsible-header" onclick="calculator.toggleZeroSalesSection()"
                            style="background-color: #fef9c3; border-color: #fde047;">
                            <div style="display: flex; align-items: center; gap: 10px;">
                                <span style="color: #854d0e; font-weight: 600;">‚ö†Ô∏è Zero Sales Keywords</span>
                                <span id="zeroSalesCount" class="text-small" style="color: #a16207;">(0 keywords)</span>
                            </div>
                            <div class="dropdown-arrow" id="arrow-zero-sales">‚ñº</div>
                        </div>
                        <div class="collapsible-content" id="content-zero-sales">
                            <p class="text-small" style="color: #854d0e; margin-bottom: 12px;">
                                These keywords have zero sales and are excluded from duplicate comparison. Review them
                                separately.
                            </p>
                            <div id="zeroSalesKeywordsList"></div>
                        </div>
                    </div>
                </div>
            </div>

            <div class="summary-grid">
                <div class="summary-card blue">
                    <div class="summary-content">
                        <div class="summary-label">Total Keywords</div>
                        <div class="summary-value" id="totalKeywords">0</div>
                    </div>
                </div>
                <div class="summary-card orange">
                    <div class="summary-content">
                        <div class="summary-label">Duplicate Keywords</div>
                        <div class="summary-value" id="duplicateCount">0</div>
                    </div>
                </div>
                <div class="summary-card red">
                    <div class="summary-content">
                        <div class="summary-label">Poor Performers</div>
                        <div class="summary-value" id="removeCount">0</div>
                    </div>
                </div>
                <div class="summary-card green">
                    <div class="summary-content">
                        <div class="summary-label">Potential Savings</div>
                        <div class="summary-value" id="potentialSavings">$0</div>
                    </div>
                </div>
            </div>

            <div id="recommendationsSection" class="recommendations" style="display: none;">
                <h3 class="section-title" style="color: #92400e; margin-bottom: 16px;">
                    üö® Consolidation Recommendations & Analysis
                </h3>

                <div class="analysis-control-panel">
                    <div class="control-row">
                        <div class="control-group"><label class="control-label">üîç Search Keywords</label><input
                                type="text" id="duplicateSearchFilter" placeholder="Search..." class="control-input">
                        </div>
                        <div class="control-group"><label class="control-label">üõçÔ∏è ASIN</label><select id="asinFilter"
                                class="control-input">
                                <option value="">All ASINs</option>
                            </select></div>
                        <div class="control-group"><label class="control-label">üìä Min. Campaigns</label><select
                                id="minCampaignsFilter" class="control-input">
                                <option value="2">2+ Campaigns</option>
                                <option value="3">3+</option>
                                <option value="4">4+</option>
                            </select></div>
                        <div class="control-group"><label class="control-label">üìà Sort By</label><select
                                id="duplicateSortFilter" class="control-input">
                                <option value="savings-desc">Highest Savings</option>
                                <option value="campaigns-desc">Most Campaigns</option>
                                <option value="keyword-asc">Keyword A-Z</option>
                            </select></div>
                        <div class="control-group"><label class="control-label">‚ö° Status</label><select
                                id="statusFilter" class="control-input">
                                <option value="">All Statuses</option>
                                <option value="enabled" selected>Enabled Keywords Only</option>
                                <option value="campaign_enabled">Enabled Campaigns Only</option>
                            </select></div>
                        <div class="control-group"><label class="control-label">üéØ Campaign Type</label><select
                                id="campaignTypeFilter" class="control-input">
                                <option value="">All Types</option>
                                <option value="SP Auto">SP Auto</option>
                                <option value="SP Manual">SP Manual</option>
                                <option value="SB Video">SB Video</option>
                                <option value="SD Display">SD Display</option>
                            </select></div>
                        <div class="control-group"><label class="control-label">‚öôÔ∏è Options</label>
                            <div style="display:flex; align-items:center; height: 37px;"><input type="checkbox"
                                    id="excludeSingleOrderFilter" style="margin-right: 8px;"><label
                                    for="excludeSingleOrderFilter" class="text-small">Exclude 1-Order KWs</label></div>
                        </div>
                    </div>
                    <div class="quick-stats-bar">
                        <div class="quick-stat"><span class="stat-value" id="totalDuplicatesFound">0</span><span
                                class="stat-label">Filtered Duplicates</span></div>
                        <div class="quick-stat"><span class="stat-value" id="campaignsToOptimize">0</span><span
                                class="stat-label">Keywords to Pause</span></div>
                        <div class="quick-stat"><span class="stat-value" id="totalWastedSpend">$0</span><span
                                class="stat-label">Total Waste</span></div>
                    </div>
                </div>

                <div id="recommendationsList" style="margin-top: 16px;"></div>

                <div class="pagination-controls" id="duplicatesPagination" style="display: none;">
                    <div><span>Showing <span id="duplicatesShowingStart">0</span>-<span
                                id="duplicatesShowingEnd">0</span> of <span id="duplicatesTotalFiltered">0</span></span>
                    </div>
                    <div><label class="text-small">Per page:</label><select id="duplicatesRowsPerPage"
                            style="margin-left: 8px; margin-right: 16px;">
                            <option value="5">5</option>
                            <option value="10" selected>10</option>
                            <option value="20">20</option>
                        </select><button id="duplicatesPrevPageBtn" class="btn btn-secondary">Previous</button><button
                            id="duplicatesNextPageBtn" class="btn btn-secondary" style="margin-left: 8px;">Next</button>
                    </div>

                    <!-- Generate Bulk File Button -->
                    <div id="exportSection"
                        style="margin-top: 20px; padding: 16px; background-color: #f0fdf4; border: 1px solid #bbf7d0; border-radius: 8px;">
                        <div
                            style="display: flex; justify-content: space-between; align-items: center; flex-wrap: wrap; gap: 12px;">
                            <div>
                                <p style="font-weight: 600; color: #166534; margin-bottom: 4px;">üì• Export Selected
                                    Keywords to Pause</p>
                                <p id="exportMessage" class="text-small" style="color: #15803d;">Upload a bulk file to
                                    enable export functionality.</p>
                            </div>
                            <div style="display: flex; gap: 12px; align-items: center;">
                                <span id="selectedCount" class="text-small" style="color: #166534;">0 keywords
                                    selected</span>
                                <button id="generateBulkFileBtn" class="btn btn-success" disabled>Generate Pause Bulk
                                    File</button>
                            </div>
                        </div>
                    </div>
                </div>

                <div class="weights-section">
                    <h3 class="section-title" style="margin-bottom: 16px;">Scoring Weights Configuration</h3>
                    <div class="weights-grid">
                        <div><label class="text-small font-bold">ACOS Weight (%)</label><input type="number"
                                id="acosWeight" value="45" min="0" max="100" class="weight-input"></div>
                        <div><label class="text-small font-bold">Conversion Weight (%)</label><input type="number"
                                id="conversionWeight" value="35" min="0" max="100" class="weight-input"></div>
                        <div><label class="text-small font-bold">Sales Weight (%)</label><input type="number"
                                id="salesWeight" value="20" min="0" max="100" class="weight-input"></div>
                    </div>
                    <div class="text-small" style="margin-top: 8px;"><span id="weightTotal">Total: 100%</span><span
                            id="weightWarning" style="color: #dc2626; display: none;"> ‚ö†Ô∏è Weights should total
                            100%</span>
                    </div>
                </div>

            </div>
        </div>

        <script>
            class KeywordCalculator {
                constructor() {
                    this.keywords = [];
                    this.weights = { acos: 45, conversion: 35, sales: 20 };
                    this.results = [];
                    this.filteredDuplicates = [];
                    this.duplicates = {};
                    this.rawData = null;
                    this.uniqueAsins = new Set();

                    // Bulk file data storage
                    this.bulkFileData = null;
                    this.bulkFileWorksheets = {};
                    this.selectedKeywordsToPause = new Map();
                    this.zeroSalesKeywords = [];

                    this.duplicatesCurrentPage = 1;
                    this.duplicatesRowsPerPage = 10;

                    this.initializeEventListeners();
                }

                initializeEventListeners() {
                    document.getElementById('fileInput').addEventListener('change', (e) => this.handleFileUpload(e));
                    document.getElementById('bulkFileInput').addEventListener('change', (e) => this.handleBulkFileUpload(e));
                    document.getElementById('applyMappingBtn').addEventListener('click', () => this.applyColumnMapping());
                    document.getElementById('generateBulkFileBtn').addEventListener('click', () => this.generatePauseBulkFile());
                    document.getElementById('processBulkOnlyBtn').addEventListener('click', () => this.processBulkFileOnly());

                    ['acosWeight', 'conversionWeight', 'salesWeight'].forEach(id => {
                        document.getElementById(id).addEventListener('input', (e) => this.updateWeight(id, e.target.value));
                    });

                    // Consolidation filter listeners
                    const recommendationFilters = ['duplicateSearchFilter', 'asinFilter', 'minCampaignsFilter', 'duplicateSortFilter', 'statusFilter', 'campaignTypeFilter', 'excludeSingleOrderFilter'];
                    recommendationFilters.forEach(id => {
                        document.getElementById(id).addEventListener('input', () => this.renderRecommendations());
                    });

                    // Duplicate pagination listeners
                    document.getElementById('duplicatesRowsPerPage').addEventListener('change', (e) => {
                        this.duplicatesRowsPerPage = parseInt(e.target.value);
                        this.duplicatesCurrentPage = 1;
                        this.renderRecommendations();
                    });

                    document.getElementById('duplicatesPrevPageBtn').addEventListener('click', () => {
                        if (this.duplicatesCurrentPage > 1) {
                            this.duplicatesCurrentPage--;
                            this.renderRecommendations();
                        }
                    });

                    document.getElementById('duplicatesNextPageBtn').addEventListener('click', () => {
                        const totalPages = Math.ceil(this.filteredDuplicates.length / this.duplicatesRowsPerPage);
                        if (this.duplicatesCurrentPage < totalPages) {
                            this.duplicatesCurrentPage++;
                            this.renderRecommendations();
                        }
                    });
                }

                showLoading(title, message) {
                    document.getElementById('loadingTitle').textContent = title;
                    document.getElementById('loadingMessage').textContent = message;
                    document.getElementById('loadingOverlay').classList.remove('hidden');
                }

                updateProgress(percent, details) {
                    document.getElementById('progressFill').style.width = percent + '%';
                    document.getElementById('loadingDetails').textContent = details;
                }

                hideLoading() {
                    document.getElementById('loadingOverlay').classList.add('hidden');
                }

                // Handle Amazon Bulk File Upload with Web Worker for performance
                async handleBulkFileUpload(event) {
                    const file = event.target.files[0];
                    if (!file) return;

                    this.showLoading('Reading Bulk File', 'Starting file processing...');
                    const fileSize = (file.size / 1024 / 1024).toFixed(2);
                    const fileName = file.name;

                    try {
                        this.updateProgress(10, 'Reading file into memory...');
                        const arrayBuffer = await file.arrayBuffer();

                        this.updateProgress(20, 'Starting background parser...');

                        // Create inline Web Worker for XLSX parsing
                        const workerCode = `
                            // Load XLSX library in worker
                            importScripts('https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js');
                            
                            self.onmessage = function(e) {
                                try {
                                    const arrayBuffer = e.data;
                                    
                                    self.postMessage({ type: 'progress', message: 'Parsing Excel file...', percent: 30 });
                                    
                                    const workbook = XLSX.read(arrayBuffer, { type: 'array' });
                                    
                                    self.postMessage({ type: 'progress', message: 'Processing worksheets...', percent: 60 });
                                    
                                    const worksheets = {};
                                    let totalKeywords = 0;
                                    let totalProductTargeting = 0;
                                    
                                    workbook.SheetNames.forEach((sheetName, idx) => {
                                        const percent = 60 + Math.floor((idx / workbook.SheetNames.length) * 30);
                                        self.postMessage({ type: 'progress', message: 'Processing ' + sheetName + '...', percent: percent });
                                        
                                        const sheetData = XLSX.utils.sheet_to_json(workbook.Sheets[sheetName], { defval: '' });
                                        if (sheetData.length > 0) {
                                            const filteredData = sheetData.filter(row => {
                                                const entity = String(row['Entity'] || '').toLowerCase();
                                                return entity === 'keyword' || entity === 'product targeting';
                                            });
                                            
                                            if (filteredData.length > 0) {
                                                worksheets[sheetName] = {
                                                    allData: sheetData,
                                                    headers: Object.keys(sheetData[0]),
                                                    keywordData: filteredData
                                                };
                                                
                                                filteredData.forEach(row => {
                                                    const entity = String(row['Entity'] || '').toLowerCase();
                                                    if (entity === 'keyword') totalKeywords++;
                                                    else if (entity === 'product targeting') totalProductTargeting++;
                                                });
                                            }
                                        }
                                    });
                                    
                                    self.postMessage({ 
                                        type: 'complete', 
                                        worksheets: worksheets,
                                        sheetNames: workbook.SheetNames,
                                        totalKeywords: totalKeywords,
                                        totalProductTargeting: totalProductTargeting
                                    });
                                    
                                } catch (error) {
                                    self.postMessage({ type: 'error', message: error.message });
                                }
                            };
                        `;

                        const blob = new Blob([workerCode], { type: 'application/javascript' });
                        const workerUrl = URL.createObjectURL(blob);
                        const worker = new Worker(workerUrl);

                        // Handle worker messages
                        worker.onmessage = (e) => {
                            const data = e.data;

                            if (data.type === 'progress') {
                                this.updateProgress(data.percent, data.message);
                            } else if (data.type === 'complete') {
                                // Store the parsed data
                                this.bulkFileWorksheets = data.worksheets;
                                this.bulkFileData = { SheetNames: data.sheetNames }; // Minimal workbook reference

                                document.getElementById('bulkFileStats').innerHTML = `‚úÖ Bulk file loaded: ${fileName} (${fileSize} MB)<br>üìä Found ${Object.keys(data.worksheets).length} worksheets with ${data.totalKeywords} keywords and ${data.totalProductTargeting} product targeting entries`;
                                document.getElementById('bulkFileStats').classList.remove('hidden');
                                document.getElementById('generateBulkFileBtn').disabled = false;
                                document.getElementById('exportMessage').textContent = 'Bulk file loaded. Select keywords to pause and click Generate.';
                                document.getElementById('processBulkOnlyBtn').style.display = 'block';

                                this.hideLoading();
                                this.updateSelectedCount();

                                // Cleanup
                                worker.terminate();
                                URL.revokeObjectURL(workerUrl);
                            } else if (data.type === 'error') {
                                console.error('Worker error:', data.message);
                                alert('Error processing bulk file: ' + data.message);
                                this.hideLoading();
                                worker.terminate();
                                URL.revokeObjectURL(workerUrl);
                            }
                        };

                        worker.onerror = (error) => {
                            console.error('Worker error:', error);
                            alert('Error processing bulk file. Please try again.');
                            this.hideLoading();
                            worker.terminate();
                            URL.revokeObjectURL(workerUrl);
                        };

                        // Start the worker with the file data
                        worker.postMessage(arrayBuffer, [arrayBuffer]);

                    } catch (error) {
                        console.error('Error processing bulk file:', error);
                        alert('Error processing bulk file. Please check the format and try again.');
                        this.hideLoading();
                    }
                    event.target.value = '';
                }

                // Process bulk file data only (without Scale Insights)
                async processBulkFileOnly() {
                    if (!this.bulkFileData || Object.keys(this.bulkFileWorksheets).length === 0) {
                        alert('Please upload a bulk file first.');
                        return;
                    }

                    this.showLoading('Processing Bulk File', 'Building ASIN lookup maps...');

                    try {
                        this.keywords = [];
                        let idCounter = 1;

                        // Step 1: Build ASIN lookup maps for each worksheet
                        // For SP: Campaign ID -> ASIN (from Product Ad entity row)
                        // For SB: Campaign ID -> Creative ASINs (from Campaign entity row)
                        const asinMaps = {};
                        const sbCampaignNames = new Set(); // For SB deduplication

                        this.updateProgress(10, 'Building ASIN lookup maps...');

                        for (const [sheetName, sheet] of Object.entries(this.bulkFileWorksheets)) {
                            const allData = sheet.allData;
                            const isSP = sheetName.toLowerCase().includes('sponsored products');
                            const isSB = sheetName.toLowerCase().includes('sponsored brands') && !sheetName.toLowerCase().includes('multi');
                            const isSBMulti = sheetName.toLowerCase().includes('multi ad group');

                            asinMaps[sheetName] = {};

                            // Build Campaign ID -> ASIN map
                            allData.forEach(row => {
                                const entity = String(row['Entity'] || '').toLowerCase();
                                const campaignId = String(row['Campaign ID'] || row['Campaign Id'] || '');

                                if (!campaignId) return;

                                if (isSP && entity === 'product ad') {
                                    // For SP: get ASIN from Product Ad row
                                    const asin = String(row['ASIN (Informational only)'] || row['ASIN'] || '');
                                    if (asin && !asinMaps[sheetName][campaignId]) {
                                        asinMaps[sheetName][campaignId] = asin;
                                    }
                                } else if ((isSB || isSBMulti) && entity === 'campaign') {
                                    // For SB: get Creative ASINs from Campaign row
                                    const creativeAsins = String(row['Creative ASINs'] || row['Creative ASIN'] || '');
                                    if (creativeAsins) {
                                        asinMaps[sheetName][campaignId] = creativeAsins;
                                    }

                                    // Track SB campaign names for deduplication
                                    if (isSB) {
                                        const campaignName = String(row['Campaign Name (Informational only)'] || row['Campaign Name'] || '').toLowerCase().trim();
                                        if (campaignName) {
                                            sbCampaignNames.add(campaignName);
                                        }
                                    }
                                }
                            });
                        }

                        this.updateProgress(30, 'Processing keywords from worksheets...');

                        // Step 2: Sort worksheets - prioritize SP and main SB over Multi Ad Group
                        const sortedSheets = Object.entries(this.bulkFileWorksheets).sort(([nameA], [nameB]) => {
                            const getPriority = (name) => {
                                const lower = name.toLowerCase();
                                if (lower.includes('sponsored products')) return 1;
                                if (lower.includes('sponsored brands') && !lower.includes('multi')) return 2;
                                if (lower.includes('multi ad group')) return 4;
                                return 3;
                            };
                            return getPriority(nameA) - getPriority(nameB);
                        });

                        // Step 3: Process keywords from each worksheet
                        let processedCount = 0;
                        const totalRows = sortedSheets.reduce((sum, [_, sheet]) => sum + sheet.keywordData.length, 0);

                        for (const [sheetName, sheet] of sortedSheets) {
                            if (sheet.keywordData.length === 0) continue;

                            const isSBMulti = sheetName.toLowerCase().includes('multi ad group');
                            const headers = sheet.headers;
                            const columnMap = this.findColumnsSmartly(headers);
                            const sheetAsinMap = asinMaps[sheetName] || {};

                            // Process in chunks to prevent UI freeze
                            const chunkSize = 500;
                            for (let i = 0; i < sheet.keywordData.length; i += chunkSize) {
                                const chunk = sheet.keywordData.slice(i, i + chunkSize);

                                chunk.forEach(row => {
                                    const entity = String(row['Entity'] || '').toLowerCase();
                                    const campaignId = String(row['Campaign ID'] || row['Campaign Id'] || '');

                                    // Get campaign name (prefer informational column)
                                    const campaignName = this.getColumnValue(row, columnMap.campaignNameInfo) ||
                                        this.getColumnValue(row, columnMap.campaignName) || '';

                                    // SB Deduplication: Skip if this is Multi Ad Group and campaign exists in main SB
                                    if (isSBMulti && sbCampaignNames.has(campaignName.toLowerCase().trim())) {
                                        return; // Skip this keyword - already processed from main SB sheet
                                    }

                                    // Get keyword text or product targeting expression
                                    let keywordText = '';
                                    let targetAsin = '';

                                    if (entity === 'keyword') {
                                        keywordText = this.getColumnValue(row, columnMap.keywordText) || '';
                                    } else if (entity === 'product targeting') {
                                        const targetingExpr = this.getColumnValue(row, columnMap.productTargeting) || '';
                                        const asinMatch = targetingExpr.match(/asin="([^"]+)"/i);
                                        if (asinMatch) {
                                            targetAsin = asinMatch[1];
                                            keywordText = targetAsin;
                                        } else {
                                            keywordText = targetingExpr;
                                        }
                                    }

                                    // Get ASIN from lookup map (via Campaign ID)
                                    const productAsin = sheetAsinMap[campaignId] || '';

                                    const adGroupName = this.getColumnValue(row, columnMap.adGroupNameInfo) ||
                                        this.getColumnValue(row, columnMap.adGroupName) || '';
                                    const matchType = this.getColumnValue(row, columnMap.matchType) || 'Unknown';

                                    // Collect metrics
                                    const allMetrics = {};
                                    columnMap.metrics.forEach(metricCol => {
                                        const value = parseFloat(row[metricCol] || 0);
                                        if (!isNaN(value)) {
                                            allMetrics[metricCol] = value;
                                        }
                                    });

                                    const sales = allMetrics['Sales'] || allMetrics['7 Day Total Sales'] || 0;
                                    const spend = allMetrics['Spend'] || allMetrics['Cost'] || 0;
                                    const clicks = allMetrics['Clicks'] || 0;
                                    const impressions = allMetrics['Impressions'] || 0;
                                    const orders = allMetrics['Orders'] || allMetrics['7 Day Total Orders (#)'] || 0;
                                    const acos = sales > 0 ? (spend / sales) * 100 : 0;
                                    const conversion = clicks > 0 ? (orders / clicks) * 100 : 0;

                                    if (keywordText && campaignName) {
                                        this.keywords.push({
                                            id: `bulk_${idCounter++}`,
                                            name: keywordText,
                                            asin: productAsin,
                                            targetAsin: targetAsin,
                                            campaign: campaignName,
                                            adGroup: adGroupName,
                                            matchType: matchType,
                                            entityType: entity,
                                            sales: sales,
                                            acos: acos,
                                            conversion: conversion,
                                            impressions: impressions,
                                            clicks: clicks,
                                            orders: orders,
                                            spend: spend,
                                            allMetrics: allMetrics,
                                            sheetName: sheetName,
                                            campaignId: campaignId
                                        });
                                    }
                                });

                                processedCount += chunk.length;
                                const progress = 30 + Math.floor((processedCount / totalRows) * 40);
                                this.updateProgress(progress, `Processing row ${processedCount} of ${totalRows}...`);

                                // Yield to UI every chunk to prevent freeze
                                await new Promise(resolve => setTimeout(resolve, 0));
                            }
                        }

                        if (this.keywords.length === 0) {
                            alert('No keyword data found in the bulk file. Please check the file format.');
                            this.hideLoading();
                            return;
                        }

                        this.updateProgress(75, `Calculating scores for ${this.keywords.length} keywords...`);
                        await new Promise(resolve => setTimeout(resolve, 0));

                        // Calculate composite scores
                        this.keywords.forEach(kw => {
                            const acosScore = kw.acos > 0 ? Math.max(0, 100 - kw.acos) : 50;
                            const convScore = Math.min(100, kw.conversion * 5);
                            const salesScore = Math.min(100, (kw.sales / 100) * 100);

                            const weights = this.weights;
                            const totalWeight = weights.acos + weights.conversion + weights.sales;

                            const compositeScore = (
                                (acosScore * weights.acos / 100) +
                                (convScore * weights.conversion / 100) +
                                (salesScore * weights.sales / 100)
                            ) * (100 / totalWeight);

                            kw.compositeScore = compositeScore.toFixed(1);
                        });

                        this.results = this.keywords;

                        this.updateProgress(85, 'Identifying duplicates...');
                        await new Promise(resolve => setTimeout(resolve, 0));

                        this.identifyDuplicates();

                        this.updateProgress(95, 'Rendering recommendations...');
                        await new Promise(resolve => setTimeout(resolve, 0));

                        this.updateSummary();
                        document.getElementById('recommendationsSection').style.display = 'block';

                        this.hideLoading();

                        const dupCount = Object.keys(this.duplicates).length;
                        const skippedCount = sbCampaignNames.size > 0 ? ` (Deduplicated ${sbCampaignNames.size} SB campaigns)` : '';
                        alert(`Successfully processed ${this.keywords.length} keywords from bulk file.${skippedCount}\n\nFound ${dupCount} duplicate groups.`);

                    } catch (error) {
                        console.error('Error processing bulk file:', error);
                        alert('Error processing bulk file: ' + error.message);
                        this.hideLoading();
                    }
                }

                // Smart column finder - finds columns by keyword matching
                findColumnsSmartly(headers) {
                    const columnMap = {
                        keywordText: null,
                        campaignName: null,
                        campaignNameInfo: null,
                        adGroupName: null,
                        adGroupNameInfo: null,
                        asin: null,
                        matchType: null,
                        productTargeting: null,
                        metrics: []
                    };

                    const metricKeywords = ['sales', 'spend', 'cost', 'clicks', 'impressions', 'orders', 'ctr', 'cpc', 'acos', 'roas', 'conversions'];

                    headers.forEach(header => {
                        const h = header.toLowerCase();

                        // Keyword Text
                        if (h.includes('keyword') && h.includes('text') && !columnMap.keywordText) {
                            columnMap.keywordText = header;
                        }

                        // Campaign Name (Informational)
                        if (h.includes('campaign') && h.includes('name') && h.includes('informational')) {
                            columnMap.campaignNameInfo = header;
                        } else if (h.includes('campaign') && h.includes('name') && !h.includes('informational') && !columnMap.campaignName) {
                            columnMap.campaignName = header;
                        }

                        // Ad Group Name (Informational)
                        if (h.includes('ad group') && h.includes('name') && h.includes('informational')) {
                            columnMap.adGroupNameInfo = header;
                        } else if (h.includes('ad group') && h.includes('name') && !h.includes('informational') && !columnMap.adGroupName) {
                            columnMap.adGroupName = header;
                        }

                        // ASIN (your product)
                        if (h.includes('asin') && h.includes('informational') && !columnMap.asin) {
                            columnMap.asin = header;
                        }

                        // Match Type
                        if (h.includes('match') && h.includes('type') && !columnMap.matchType) {
                            columnMap.matchType = header;
                        }

                        // Product Targeting Expression
                        if (h.includes('product') && h.includes('targeting') && h.includes('expression') && !h.includes('resolved')) {
                            columnMap.productTargeting = header;
                        }

                        // Detect metrics columns
                        for (const keyword of metricKeywords) {
                            if (h.includes(keyword) && !columnMap.metrics.includes(header)) {
                                columnMap.metrics.push(header);
                                break;
                            }
                        }
                    });

                    return columnMap;
                }

                // Helper to get column value safely
                getColumnValue(row, columnName) {
                    if (!columnName) return null;
                    return row[columnName] !== undefined ? String(row[columnName]) : null;
                }

                // Extract product+variation, campaign type, and match type from campaign name
                parseCampaignName(campaignName) {
                    const parts = campaignName.split('|').map(p => p.trim());
                    const productVariation = parts[0] || '';

                    let campaignType = 'Other';
                    let matchType = 'Unknown';

                    // Search through all segments for campaign type and match type
                    parts.forEach(segment => {
                        const seg = segment.toUpperCase();

                        // Detect campaign type
                        if (campaignType === 'Other') {
                            if (seg.includes('SP')) campaignType = 'SP';
                            else if (seg.includes('SB')) campaignType = 'SB';
                            else if (seg.includes('SD')) campaignType = 'SD';
                        }

                        // Detect match type (smart detection - search all segments)
                        if (matchType === 'Unknown') {
                            if (seg.includes('BROAD')) matchType = 'Broad';
                            else if (seg.includes('PHRASE')) matchType = 'Phrase';
                            else if (seg.includes('EXACT')) matchType = 'Exact';
                            else if (seg.includes('AUTO')) matchType = 'Auto';
                        }
                    });

                    return {
                        productVariation: productVariation.toLowerCase(),
                        campaignType,
                        matchType
                    };
                }

                // Update selected count display
                updateSelectedCount() {
                    const count = this.selectedKeywordsToPause.size;
                    document.getElementById('selectedCount').textContent = `${count} keywords selected`;
                }

                // Toggle keyword selection
                toggleKeywordSelection(keywordId, isChecked) {
                    if (isChecked) {
                        this.selectedKeywordsToPause.set(keywordId, true);
                    } else {
                        this.selectedKeywordsToPause.delete(keywordId);
                    }
                    this.updateSelectedCount();
                }

                async handleFileUpload(event) {
                    const file = event.target.files[0];
                    if (!file) return;
                    this.showLoading('Reading File', 'Processing your upload...');
                    try {
                        const fileSize = (file.size / 1024 / 1024).toFixed(2);
                        document.getElementById('fileStats').innerHTML = `File: ${file.name} (${fileSize} MB)`;
                        document.getElementById('fileStats').classList.remove('hidden');
                        this.updateProgress(25, 'Reading file contents...');

                        if (file.name.endsWith('.csv')) {
                            const text = await file.text();
                            this.updateProgress(50, 'Parsing CSV data...');
                            Papa.parse(text, {
                                header: true,
                                skipEmptyLines: true,
                                complete: (result) => {
                                    this.rawData = result.data;
                                    this.setupColumnMapping(result.meta.fields);
                                    this.hideLoading();
                                }
                            });
                        } else if (file.name.endsWith('.xlsx')) {
                            const arrayBuffer = await file.arrayBuffer();
                            this.updateProgress(50, 'Parsing Excel data...');
                            const workbook = XLSX.read(arrayBuffer, { type: 'array' });
                            const sheetName = workbook.SheetNames[0];
                            this.rawData = XLSX.utils.sheet_to_json(workbook.Sheets[sheetName]);
                            if (this.rawData.length > 0) this.setupColumnMapping(Object.keys(this.rawData[0]));
                            this.hideLoading();
                        }
                    } catch (error) {
                        console.error('Error processing file:', error);
                        alert('Error processing file. Please check the format and try again.');
                        this.hideLoading();
                    }
                    event.target.value = '';
                }

                setupColumnMapping(columns) {
                    const mappingSection = document.getElementById('columnMapping');
                    mappingSection.style.display = 'block';

                    const selects = {
                        campaignColumnSelect: /campaign/i,
                        keywordColumnSelect: /keyword|search term/i,
                        asinColumnSelect: /asin/i,
                        salesColumnSelect: /sales/i,
                        ordersColumnSelect: /orders/i,
                        conversionColumnSelect: /conversion|cvr/i,
                        acosColumnSelect: /acos/i,
                        campaignStatusColumnSelect: /campaign status/i,
                        keywordStatusColumnSelect: /keyword status|status/i,
                    };

                    Object.keys(selects).forEach(selectId => {
                        const select = document.getElementById(selectId);
                        select.innerHTML = '<option value="">Select Column</option>';
                        columns.forEach(col => {
                            select.innerHTML += `<option value="${col}">${col}</option>`;
                        });
                        const pattern = selects[selectId];
                        const matchingColumn = columns.find(col => pattern.test(col));
                        if (matchingColumn) {
                            select.value = matchingColumn;
                        }
                    });
                }

                async applyColumnMapping() {
                    const requiredCols = ['campaignColumnSelect', 'keywordColumnSelect', 'salesColumnSelect', 'acosColumnSelect', 'asinColumnSelect', 'ordersColumnSelect'];
                    for (const colId of requiredCols) {
                        if (!document.getElementById(colId).value) {
                            alert(`Please map all required columns. '${colId.replace("ColumnSelect", "")}' is missing.`);
                            return;
                        }
                    }

                    this.showLoading('Processing Data', 'Mapping columns and processing keywords...');
                    const colMap = {
                        campaign: document.getElementById('campaignColumnSelect').value,
                        name: document.getElementById('keywordColumnSelect').value,
                        asin: document.getElementById('asinColumnSelect').value,
                        sales: document.getElementById('salesColumnSelect').value,
                        orders: document.getElementById('ordersColumnSelect').value,
                        conversion: document.getElementById('conversionColumnSelect').value,
                        acos: document.getElementById('acosColumnSelect').value,
                        campaignStatus: document.getElementById('campaignStatusColumnSelect').value,
                        keywordStatus: document.getElementById('keywordStatusColumnSelect').value,
                    };

                    const newKeywords = this.rawData.map((row, index) => {
                        const clean = (val) => String(val || '').toLowerCase().trim();
                        return {
                            id: Date.now() + index,
                            campaign: row[colMap.campaign] || 'N/A',
                            name: row[colMap.name] || 'N/A',
                            asin: row[colMap.asin] || 'N/A',
                            sales: parseFloat(String(row[colMap.sales]).replace(/[^0-9.-]+/g, "")) || 0,
                            orders: parseInt(row[colMap.orders]) || 0,
                            conversion: parseFloat(String(row[colMap.conversion]).replace(/[^0-9.-]+/g, "")) || 0,
                            acos: parseFloat(String(row[colMap.acos]).replace(/[^0-9.-]+/g, "")) || 0,
                            campaignStatus: clean(row[colMap.campaignStatus]) || 'enabled',
                            keywordStatus: clean(row[colMap.keywordStatus]) || 'enabled'
                        };
                    }).filter(k => k.name !== 'N/A' && k.asin !== 'N/A');

                    this.keywords = newKeywords;
                    this.populateAsinFilter();
                    document.getElementById('columnMapping').style.display = 'none';

                    setTimeout(() => {
                        this.hideLoading();
                        this.calculateScores();
                    }, 500);
                }

                populateAsinFilter() {
                    this.uniqueAsins = new Set(this.keywords.map(k => k.asin));
                    const asinFilter = document.getElementById('asinFilter');
                    asinFilter.innerHTML = '<option value="">All ASINs</option>';
                    this.uniqueAsins.forEach(asin => {
                        asinFilter.innerHTML += `<option value="${asin}">${asin}</option>`;
                    });
                }

                updateWeight(fieldId, value) {
                    this.weights[fieldId.replace('Weight', '')] = parseInt(value) || 0;
                    this.calculateScores();
                }

                async calculateScores() {
                    if (this.keywords.length === 0) return;

                    const salesValues = this.keywords.map(k => k.sales);
                    const conversionValues = this.keywords.map(k => k.conversion);
                    const acosValues = this.keywords.map(k => k.acos);

                    const minSales = Math.min(...salesValues), maxSales = Math.max(...salesValues);
                    const minConversion = Math.min(...conversionValues), maxConversion = Math.max(...conversionValues);
                    const minAcos = Math.min(...acosValues), maxAcos = Math.max(...acosValues);

                    this.results = this.keywords.map(keyword => {
                        const salesScore = maxSales === minSales ? 100 : ((keyword.sales - minSales) / (maxSales - minSales)) * 100;
                        const conversionScore = maxConversion === minConversion ? 100 : ((keyword.conversion - minConversion) / (maxConversion - minConversion)) * 100;
                        const acosScore = maxAcos === minAcos ? 100 : ((maxAcos - keyword.acos) / (maxAcos - minAcos)) * 100;
                        const compositeScore = (acosScore * this.weights.acos / 100) + (conversionScore * this.weights.conversion / 100) + (salesScore * this.weights.sales / 100);
                        return { ...keyword, compositeScore: compositeScore.toFixed(1) };
                    });

                    this.identifyDuplicates();
                    this.updateSummary();
                }

                identifyDuplicates() {
                    const keywordGroups = {};
                    this.zeroSalesKeywords = []; // Store zero sales keywords separately

                    this.results.forEach(keyword => {
                        // Exclude zero sales keywords from duplicate comparison
                        if (keyword.sales === 0 || keyword.sales === '0') {
                            this.zeroSalesKeywords.push(keyword);
                            return; // Skip this keyword in duplicate grouping
                        }

                        // Parse campaign name to extract product+variation and campaign type
                        const parsed = this.parseCampaignName(keyword.campaign);

                        // Use matchType from keyword data if available (from bulk file), otherwise use parsed
                        const matchType = keyword.matchType || parsed.matchType;

                        // Grouping key: keyword + asin + product+variation + campaign type + match type
                        const key = `${keyword.name.toLowerCase().trim()}|${keyword.asin.toLowerCase().trim()}|${parsed.productVariation}|${parsed.campaignType}|${matchType}`;
                        if (!keywordGroups[key]) keywordGroups[key] = [];
                        keywordGroups[key].push(keyword);
                    });
                    this.duplicates = Object.fromEntries(Object.entries(keywordGroups).filter(([_, v]) => v.length > 1));

                    // Clear and rebuild selected keywords map with new duplicates (all checked by default)
                    this.selectedKeywordsToPause.clear();
                    Object.values(this.duplicates).forEach(list => {
                        const sorted = [...list].sort((a, b) => parseFloat(b.compositeScore) - parseFloat(a.compositeScore));
                        // Skip the best one, select all others for pausing
                        sorted.slice(1).forEach(kw => {
                            this.selectedKeywordsToPause.set(kw.id, true);
                        });
                    });

                    this.renderRecommendations();
                    this.updateSelectedCount();
                }

                getCampaignType(campaignName) {
                    const name = campaignName.toLowerCase();
                    if (name.includes('sp') && name.includes('auto')) return 'SP Auto';
                    if (name.includes('sp') && (name.includes('manual') || name.includes('keyword') || name.includes('product'))) return 'SP Manual';
                    if (name.includes('sb') && name.includes('video')) return 'SB Video';
                    if (name.includes('sd') && name.includes('display')) return 'SD Display';
                    return 'Other';
                }

                renderRecommendations() {
                    const section = document.getElementById('recommendationsSection');
                    const list = document.getElementById('recommendationsList');
                    const paginationControls = document.getElementById('duplicatesPagination');

                    // Also render zero sales keywords
                    this.renderZeroSalesKeywords();

                    if (Object.keys(this.duplicates).length === 0) {
                        // Hide the duplicate list but keep section if there are zero sales keywords
                        if (this.zeroSalesKeywords && this.zeroSalesKeywords.length > 0) {
                            section.style.display = 'block';
                            list.innerHTML = '<p class="text-small" style="color: #78350f; text-align: center; padding: 20px;">No duplicate keywords found (excluding zero sales keywords shown below).</p>';
                            paginationControls.style.display = 'none';
                        } else {
                            section.style.display = 'none';
                        }
                        return;
                    }
                    section.style.display = 'block';

                    // 1. Get filter values
                    const searchFilter = document.getElementById('duplicateSearchFilter').value.toLowerCase();
                    const asinFilter = document.getElementById('asinFilter').value;
                    const minCampaigns = parseInt(document.getElementById('minCampaignsFilter').value);
                    const sortFilter = document.getElementById('duplicateSortFilter').value;
                    const statusFilter = document.getElementById('statusFilter').value;
                    const campaignTypeFilter = document.getElementById('campaignTypeFilter').value;
                    const excludeSingleOrder = document.getElementById('excludeSingleOrderFilter').checked;

                    // 2. Process and filter duplicates - filter keywords WITHIN each group first
                    let processedDuplicates = Object.values(this.duplicates).map(keywordList => {
                        let filteredList = [...keywordList];

                        // Apply status filter to individual keywords within the group
                        if (statusFilter === 'enabled') {
                            filteredList = filteredList.filter(kw => kw.keywordStatus === 'enabled');
                        } else if (statusFilter === 'campaign_enabled') {
                            filteredList = filteredList.filter(kw => kw.campaignStatus === 'enabled');
                        }

                        // Apply campaign type filter to individual keywords
                        if (campaignTypeFilter) {
                            filteredList = filteredList.filter(kw => this.getCampaignType(kw.campaign) === campaignTypeFilter);
                        }

                        // Sort by score after filtering
                        const sortedByScore = filteredList.sort((a, b) => parseFloat(b.compositeScore) - parseFloat(a.compositeScore));
                        return { list: sortedByScore, asin: sortedByScore.length > 0 ? sortedByScore[0].asin : '' };
                    }).filter(group => group.list.length > 1); // Only keep groups with 2+ keywords after filtering

                    // Apply remaining group-level filters
                    if (asinFilter) processedDuplicates = processedDuplicates.filter(item => item.asin === asinFilter);
                    if (excludeSingleOrder) processedDuplicates = processedDuplicates.filter(group => !group.list.every(kw => kw.orders <= 1));

                    this.filteredDuplicates = processedDuplicates.map(group => {
                        const best = group.list[0];
                        const rest = group.list.slice(1);
                        const savings = rest.reduce((sum, kw) => sum + (kw.sales * (kw.acos / 100)), 0);
                        return { best, rest, savings, count: group.list.length };
                    }).filter(item =>
                        item.count >= minCampaigns &&
                        item.best.name.toLowerCase().includes(searchFilter)
                    );

                    // 3. Apply sorting
                    if (sortFilter === 'savings-desc') this.filteredDuplicates.sort((a, b) => b.savings - a.savings);
                    else if (sortFilter === 'campaigns-desc') this.filteredDuplicates.sort((a, b) => b.count - a.count);
                    else if (sortFilter === 'keyword-asc') this.filteredDuplicates.sort((a, b) => a.best.name.localeCompare(b.best.name));

                    // 4. Update stats and pagination
                    const totalWastedSpend = this.filteredDuplicates.reduce((sum, item) => sum + item.savings, 0);
                    const keywordsToPause = this.filteredDuplicates.reduce((sum, item) => sum + item.rest.length, 0);
                    document.getElementById('totalDuplicatesFound').textContent = this.filteredDuplicates.length;
                    document.getElementById('totalWastedSpend').textContent = `$${totalWastedSpend.toFixed(0)}`;
                    document.getElementById('campaignsToOptimize').textContent = keywordsToPause;

                    // Pagination logic
                    const totalItems = this.filteredDuplicates.length;
                    paginationControls.style.display = totalItems > 0 ? 'flex' : 'none';
                    if (totalItems === 0) { list.innerHTML = '<p style="text-align: center; padding: 24px; color: #6b7280;">No duplicates match filters.</p>'; return; }
                    const totalPages = Math.ceil(totalItems / this.duplicatesRowsPerPage);
                    this.duplicatesCurrentPage = Math.min(this.duplicatesCurrentPage, totalPages) || 1;
                    const startIndex = (this.duplicatesCurrentPage - 1) * this.duplicatesRowsPerPage;
                    const endIndex = Math.min(startIndex + this.duplicatesRowsPerPage, totalItems);
                    const pageData = this.filteredDuplicates.slice(startIndex, endIndex);

                    document.getElementById('duplicatesShowingStart').textContent = totalItems > 0 ? startIndex + 1 : 0;
                    document.getElementById('duplicatesShowingEnd').textContent = endIndex;
                    document.getElementById('duplicatesTotalFiltered').textContent = totalItems;
                    document.getElementById('duplicatesPrevPageBtn').disabled = this.duplicatesCurrentPage <= 1;
                    document.getElementById('duplicatesNextPageBtn').disabled = this.duplicatesCurrentPage >= totalPages;

                    // 5. Render UI
                    list.innerHTML = '';
                    pageData.forEach((rec, index) => {
                        const absoluteIndex = startIndex + index;
                        const item = document.createElement('div');
                        item.className = 'collapsible-section';
                        const { best, rest, savings, count } = rec;

                        item.innerHTML = `
                        <div class="collapsible-header" onclick="calculator.toggleCollapsible(${absoluteIndex})">
                            <div><strong>${best.name}</strong> (${best.asin}) - ${count} campaigns - <span style="color: #15803d; cursor: help;" title="Savings = Sales √ó (ACOS/100) = Ad spend saved by pausing">$${savings.toFixed(2)} savings ‚ÑπÔ∏è</span></div>
                            <div class="dropdown-arrow" id="arrow-${absoluteIndex}">‚ñº</div>
                        </div>
                        <div class="collapsible-content" id="content-${absoluteIndex}">
                            <div class="recommendation-grid">
                                <div class="keep-section">
                                    <p class="text-small font-bold" style="color: #15803d; margin-bottom: 4px;">‚úÖ KEEP THIS KEYWORD:</p>
                                    <p class="font-bold" style="color: #166534;">${best.campaign}</p>
                                    <p class="text-small" style="color: #16a34a;">Performance Score: ${best.compositeScore}</p>
                                    <p class="metrics-details">Sales: $${best.sales.toFixed(2)} | Conv: ${best.conversion.toFixed(2)}% | ACOS: ${best.acos.toFixed(2)}%</p>
                                    ${this.formatExtraMetrics(best)}
                                </div>
                                <div class="remove-section">
                                    <p class="text-small font-bold" style="color: #dc2626; margin-bottom: 4px;">‚ùå PAUSE THESE KEYWORDS:</p>
                                    ${rest.length > 0 ? rest.map(kw => `
                                        <div style="margin-top: 8px; display: flex; align-items: flex-start; gap: 8px;">
                                            <input type="checkbox" 
                                                id="pause-kw-${kw.id}" 
                                                ${this.selectedKeywordsToPause.has(kw.id) ? 'checked' : ''} 
                                                onchange="calculator.toggleKeywordSelection(${kw.id}, this.checked)"
                                                style="margin-top: 4px; cursor: pointer;">
                                            <div style="flex: 1;">
                                                <label for="pause-kw-${kw.id}" class="font-bold" style="color: #b91c1c; cursor: pointer;">${kw.campaign}</label>
                                                <span class="text-small" style="color: #dc2626; margin-left: 8px;">(Score: ${kw.compositeScore})</span>
                                                <p class="metrics-details">Sales: $${kw.sales.toFixed(2)} | Conv: ${kw.conversion.toFixed(2)}% | ACOS: ${kw.acos.toFixed(2)}%</p>
                                                ${calculator.formatExtraMetrics(kw)}
                                            </div>
                                        </div>`).join('') : '<p class="text-small">None</p>'}
                                </div>
                            </div>
                        </div>`;
                        list.appendChild(item);
                    });
                }

                toggleCollapsible(index) {
                    const content = document.getElementById(`content-${index}`);
                    const arrow = document.getElementById(`arrow-${index}`);
                    content.classList.toggle('expanded');
                    arrow.classList.toggle('rotated');
                }

                // Format extra metrics from allMetrics object for display
                formatExtraMetrics(keyword) {
                    if (!keyword.allMetrics || Object.keys(keyword.allMetrics).length === 0) {
                        // Fallback: show impressions, clicks, spend if available
                        const extras = [];
                        if (keyword.impressions !== undefined && keyword.impressions > 0) {
                            extras.push(`Impressions: ${keyword.impressions.toLocaleString()}`);
                        }
                        if (keyword.clicks !== undefined && keyword.clicks > 0) {
                            extras.push(`Clicks: ${keyword.clicks.toLocaleString()}`);
                        }
                        if (keyword.spend !== undefined && keyword.spend > 0) {
                            extras.push(`Spend: $${keyword.spend.toFixed(2)}`);
                        }
                        if (keyword.orders !== undefined && keyword.orders > 0) {
                            extras.push(`Orders: ${keyword.orders}`);
                        }
                        if (extras.length === 0) return '';
                        return `<p class="metrics-details" style="margin-top: 4px; color: #6b7280;">${extras.join(' | ')}</p>`;
                    }

                    // Display all metrics from allMetrics object
                    const skipKeys = ['Sales', 'Spend', 'ACOS', 'Conversion', '7 Day Total Sales', 'Cost'];
                    const extras = [];

                    Object.entries(keyword.allMetrics).forEach(([key, value]) => {
                        // Skip main metrics already shown
                        const keyLower = key.toLowerCase();
                        if (skipKeys.some(sk => keyLower.includes(sk.toLowerCase()))) return;

                        // Format the value
                        let formattedValue;
                        if (keyLower.includes('rate') || keyLower.includes('ctr')) {
                            formattedValue = `${(value * 100).toFixed(2)}%`;
                        } else if (keyLower.includes('cpc') || keyLower.includes('cost')) {
                            formattedValue = `$${value.toFixed(2)}`;
                        } else if (Number.isInteger(value)) {
                            formattedValue = value.toLocaleString();
                        } else {
                            formattedValue = value.toFixed(2);
                        }

                        // Clean up key name for display
                        const displayKey = key.replace(/\(Informational only\)/gi, '').trim();
                        extras.push(`${displayKey}: ${formattedValue}`);
                    });

                    if (extras.length === 0) return '';
                    return `<p class="metrics-details" style="margin-top: 4px; color: #6b7280;">${extras.join(' | ')}</p>`;
                }


                toggleZeroSalesSection() {
                    const content = document.getElementById('content-zero-sales');
                    const arrow = document.getElementById('arrow-zero-sales');
                    content.classList.toggle('expanded');
                    arrow.classList.toggle('rotated');
                }

                renderZeroSalesKeywords() {
                    const section = document.getElementById('zeroSalesSection');
                    const list = document.getElementById('zeroSalesKeywordsList');
                    const countSpan = document.getElementById('zeroSalesCount');

                    if (!this.zeroSalesKeywords || this.zeroSalesKeywords.length === 0) {
                        section.style.display = 'none';
                        return;
                    }

                    section.style.display = 'block';
                    countSpan.textContent = `(${this.zeroSalesKeywords.length} keywords)`;

                    list.innerHTML = this.zeroSalesKeywords.map(kw => `
                        <div style="padding: 8px 12px; background: #fefce8; border-radius: 6px; margin-bottom: 8px; border: 1px solid #fde047;">
                            <div style="display: flex; justify-content: space-between; align-items: center;">
                                <div>
                                    <span class="font-bold" style="color: #854d0e;">${kw.name}</span>
                                    <span class="text-small" style="color: #a16207; margin-left: 8px;">(${kw.asin})</span>
                                </div>
                                <span class="text-small" style="color: #92400e;">Score: ${kw.compositeScore}</span>
                            </div>
                            <p class="text-small" style="color: #78350f; margin-top: 4px;">${kw.campaign}</p>
                            <p class="metrics-details" style="margin-top: 4px;">Sales: $0.00 | Conv: ${kw.conversion.toFixed(2)}% | ACOS: ${kw.acos.toFixed(2)}%</p>
                        </div>
                    `).join('');
                }

                updateSummary() {
                    const totalKeywords = this.results.length;
                    const duplicateCount = Object.keys(this.duplicates).length;
                    const removeCount = this.results.filter(r => parseFloat(r.compositeScore) < 40).length;
                    const totalSavings = Object.values(this.duplicates).reduce((sum, list) => {
                        const sorted = list.sort((a, b) => b.compositeScore - a.compositeScore);
                        const rest = sorted.slice(1);
                        return sum + rest.reduce((subSum, kw) => subSum + (kw.sales * (kw.acos / 100)), 0);
                    }, 0);
                    document.getElementById('totalKeywords').textContent = totalKeywords;
                    document.getElementById('duplicateCount').textContent = duplicateCount;
                    document.getElementById('removeCount').textContent = removeCount;
                    document.getElementById('potentialSavings').textContent = `$${totalSavings.toFixed(0)}`;
                }

                // Generate pause bulk file for download
                generatePauseBulkFile() {
                    if (!this.bulkFileData || Object.keys(this.bulkFileWorksheets).length === 0) {
                        alert('Please upload a bulk file first.');
                        return;
                    }

                    if (this.selectedKeywordsToPause.size === 0) {
                        alert('No keywords selected to pause. Please select at least one keyword.');
                        return;
                    }

                    this.showLoading('Generating Bulk File', 'Creating pause bulk file...');

                    try {
                        // Get all keywords that should be paused (by campaign name + keyword text)
                        const keywordsToPause = new Set();
                        this.results.forEach(kw => {
                            if (this.selectedKeywordsToPause.has(kw.id)) {
                                // Store campaign name + keyword/asin for matching
                                keywordsToPause.add(`${kw.campaign.toLowerCase().trim()}|${kw.name.toLowerCase().trim()}`);
                            }
                        });

                        // DEBUG: Log what keywords we're looking for
                        console.log('=== DEBUG: Keywords to Pause ===');
                        console.log('Total keywords selected:', keywordsToPause.size);
                        console.log('Keywords to find:', Array.from(keywordsToPause).slice(0, 10));

                        // Create new workbook for output
                        const outputWorkbook = XLSX.utils.book_new();
                        let totalRowsPaused = 0;

                        // Track which keywords we've already processed (for SB deduplication)
                        const processedKeywords = new Set();

                        // Sort worksheets to prioritize main sheets over multi ad group
                        const sortedSheets = Object.entries(this.bulkFileWorksheets).sort(([nameA], [nameB]) => {
                            // Priority order: Sponsored Products first, then main SB, then Multi Ad Group last
                            const getPriority = (name) => {
                                const lower = name.toLowerCase();
                                if (lower.includes('sponsored products')) return 1;
                                if (lower.includes('sponsored brands') && !lower.includes('multi')) return 2;
                                if (lower.includes('multi ad group')) return 4;
                                return 3;
                            };
                            return getPriority(nameA) - getPriority(nameB);
                        });

                        // DEBUG: Log worksheets being processed
                        console.log('=== DEBUG: Worksheets to process ===');
                        console.log('Sheet order:', sortedSheets.map(([name]) => name));

                        // Process each worksheet
                        sortedSheets.forEach(([sheetName, sheetInfo]) => {
                            const { allData, headers } = sheetInfo;

                            // Smart column detection
                            const columnMap = this.findColumnsSmartly(headers);

                            // DEBUG: Log column detection for this sheet
                            console.log(`\n=== DEBUG: Processing ${sheetName} ===`);
                            console.log('Column detection:', {
                                keywordText: columnMap.keywordText,
                                campaignNameInfo: columnMap.campaignNameInfo,
                                campaignName: columnMap.campaignName,
                                productTargeting: columnMap.productTargeting
                            });
                            console.log('Total rows in sheet:', allData.length);

                            // DEBUG: Log sample match keys from this sheet
                            let sampleKeys = [];
                            let keywordCount = 0;

                            // Filter rows: only Keyword/Product Targeting entities that match selected keywords
                            const filteredRows = allData.filter(row => {
                                const entity = String(row['Entity'] || '').toLowerCase();
                                if (entity !== 'keyword' && entity !== 'product targeting') return false;

                                // Get campaign name (prefer informational column)
                                const campaignName = String(
                                    this.getColumnValue(row, columnMap.campaignNameInfo) ||
                                    this.getColumnValue(row, columnMap.campaignName) || ''
                                ).toLowerCase().trim();

                                let keywordText = '';

                                if (entity === 'keyword') {
                                    keywordText = String(this.getColumnValue(row, columnMap.keywordText) || '').toLowerCase().trim();
                                } else if (entity === 'product targeting') {
                                    // Extract ASIN from Product Targeting Expression
                                    // Format can be: asin="B09CV3NHDL" or just B09CV3NHDL
                                    let ptValue = String(this.getColumnValue(row, columnMap.productTargeting) || '').trim();

                                    // Extract ASIN from asin="XXXX" format
                                    const asinMatch = ptValue.match(/asin\s*=\s*"?([A-Z0-9]+)"?/i);
                                    if (asinMatch) {
                                        keywordText = asinMatch[1].toLowerCase();
                                    } else {
                                        // Fallback: use the raw value (might already be just the ASIN)
                                        keywordText = ptValue.toLowerCase();
                                    }
                                }

                                const matchKey = `${campaignName}|${keywordText}`;

                                // DEBUG: Collect sample keys
                                keywordCount++;
                                if (sampleKeys.length < 5) {
                                    sampleKeys.push(matchKey);
                                }

                                // Check if already processed (for SB deduplication)
                                if (processedKeywords.has(matchKey)) {
                                    return false;
                                }

                                if (keywordsToPause.has(matchKey)) {
                                    processedKeywords.add(matchKey);
                                    return true;
                                }
                                return false;
                            });

                            // DEBUG: Log results for this sheet
                            console.log(`Keywords/PT rows in ${sheetName}:`, keywordCount);
                            console.log('Sample keys from bulk file:', sampleKeys);
                            console.log('Matched rows:', filteredRows.length);

                            if (filteredRows.length > 0) {
                                // Update State to 'paused' and add Operation='update' for all matched rows
                                const updatedRows = filteredRows.map(row => {
                                    const newRow = { ...row };

                                    // Add 'update' to Operation column
                                    if ('Operation' in newRow) newRow['Operation'] = 'update';
                                    else if ('operation' in newRow) newRow['operation'] = 'update';
                                    else newRow['Operation'] = 'update'; // Add if doesn't exist

                                    // Find the State column (could be various names)
                                    if ('State' in newRow) newRow['State'] = 'paused';
                                    else if ('state' in newRow) newRow['state'] = 'paused';
                                    return newRow;
                                });

                                totalRowsPaused += updatedRows.length;

                                // Create worksheet with all original columns
                                const ws = XLSX.utils.json_to_sheet(updatedRows, { header: headers });

                                // Determine output sheet name (combine SB sheets into one)
                                let outputSheetName = sheetName;
                                if (sheetName.toLowerCase().includes('multi ad group')) {
                                    outputSheetName = 'Sponsored Brands Campaigns';
                                }

                                // If sheet already exists, append to it
                                if (outputWorkbook.SheetNames.includes(outputSheetName)) {
                                    // Append rows to existing sheet
                                    const existingWs = outputWorkbook.Sheets[outputSheetName];
                                    const existingData = XLSX.utils.sheet_to_json(existingWs);
                                    const combinedData = [...existingData, ...updatedRows];
                                    const combinedWs = XLSX.utils.json_to_sheet(combinedData, { header: headers });
                                    outputWorkbook.Sheets[outputSheetName] = combinedWs;
                                } else {
                                    XLSX.utils.book_append_sheet(outputWorkbook, ws, outputSheetName);
                                }
                            }
                        });

                        if (totalRowsPaused === 0) {
                            this.hideLoading();
                            alert('No matching keywords found in the bulk file. Please ensure the campaign names and keywords match between the files.');
                            return;
                        }

                        // Generate and download file
                        const timestamp = new Date().toISOString().slice(0, 10).replace(/-/g, '');
                        const fileName = `pause_keywords_bulk_${timestamp}.xlsx`;
                        XLSX.writeFile(outputWorkbook, fileName);

                        this.hideLoading();
                        alert(`Success! Generated bulk file with ${totalRowsPaused} keywords to pause.\nFile: ${fileName}`);

                    } catch (error) {
                        console.error('Error generating bulk file:', error);
                        this.hideLoading();
                        alert('Error generating bulk file. Please try again.');
                    }
                }
            }

            let calculator;
            document.addEventListener('DOMContentLoaded', () => {
                calculator = new KeywordCalculator();
            });
        </script>
</body>

</html>
