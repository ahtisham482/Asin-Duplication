<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Amazon Keyword Performance Calculator</title>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/PapaParse/5.4.1/papaparse.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
            background-color: #f9fafb;
            color: #374151;
            line-height: 1.6;
        }

        .container {
            max-width: 1400px;
            margin: 0 auto;
            padding: 24px;
        }

        .card {
            background: white;
            border-radius: 8px;
            box-shadow: 0 4px 6px -1px rgba(0, 0, 0, 0.1);
            padding: 24px;
            margin-bottom: 24px;
        }

        .header {
            display: flex;
            align-items: center;
            gap: 12px;
            margin-bottom: 24px;
        }

        .header h1 {
            font-size: 32px;
            font-weight: bold;
            color: #1f2937;
        }

        .icon {
            width: 32px;
            height: 32px;
            color: #2563eb;
        }

        .loading-overlay {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background-color: rgba(0, 0, 0, 0.5);
            display: flex;
            justify-content: center;
            align-items: center;
            z-index: 1000;
        }

        .loading-content {
            background: white;
            padding: 32px;
            border-radius: 8px;
            text-align: center;
            max-width: 400px;
        }

        .loading-spinner {
            width: 40px;
            height: 40px;
            border: 4px solid #f3f4f6;
            border-top: 4px solid #2563eb;
            border-radius: 50%;
            animation: spin 1s linear infinite;
            margin: 0 auto 16px;
        }

        @keyframes spin {
            0% {
                transform: rotate(0deg);
            }

            100% {
                transform: rotate(360deg);
            }
        }

        .progress-bar {
            width: 100%;
            height: 8px;
            background-color: #f3f4f6;
            border-radius: 4px;
            margin: 16px 0;
            overflow: hidden;
        }

        .progress-fill {
            height: 100%;
            background-color: #2563eb;
            border-radius: 4px;
            transition: width 0.3s ease;
        }

        .summary-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(250px, 1fr));
            gap: 16px;
            margin-bottom: 24px;
        }

        .summary-card {
            padding: 16px;
            border-radius: 8px;
            display: flex;
            justify-content: between;
            align-items: center;
        }

        .summary-card.blue {
            background-color: #eff6ff;
        }

        .summary-card.orange {
            background-color: #fff7ed;
        }

        .summary-card.red {
            background-color: #fef2f2;
        }

        .summary-card.green {
            background-color: #f0fdf4;
        }

        .summary-content {
            flex: 1;
        }

        .summary-label {
            font-size: 14px;
            font-weight: 500;
            margin-bottom: 4px;
        }

        .summary-value {
            font-size: 24px;
            font-weight: bold;
        }

        .blue .summary-label,
        .blue .summary-value {
            color: #1d4ed8;
        }

        .orange .summary-label,
        .orange .summary-value {
            color: #ea580c;
        }

        .red .summary-label,
        .red .summary-value {
            color: #dc2626;
        }

        .green .summary-label,
        .green .summary-value {
            color: #16a34a;
        }

        .upload-section {
            background-color: #eff6ff;
            border: 1px solid #bfdbfe;
            border-radius: 8px;
            padding: 16px;
            margin-bottom: 24px;
        }

        .upload-header {
            display: flex;
            align-items: center;
            gap: 12px;
            margin-bottom: 12px;
        }

        .upload-header h3 {
            font-size: 18px;
            font-weight: 600;
            color: #1e40af;
        }

        .file-input {
            display: block;
            width: 100%;
            padding: 8px 0;
            font-size: 14px;
            color: #6b7280;
        }

        .column-mapping {
            margin-top: 12px;
            padding: 12px;
            background-color: #f0f9ff;
            border-radius: 6px;
            display: none;
        }

        .mapping-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 12px;
            margin-top: 8px;
        }

        .weights-section {
            background-color: #f9fafb;
            border-radius: 8px;
            padding: 16px;
            margin-bottom: 24px;
        }

        .weights-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 16px;
        }

        .weight-input,
        .mapping-select,
        .filter-input,
        .control-input {
            width: 100%;
            padding: 8px 12px;
            border: 1px solid #d1d5db;
            border-radius: 6px;
            font-size: 14px;
            background-color: white;
        }

        .weight-input:focus,
        .mapping-select:focus,
        .filter-input:focus,
        .control-input:focus {
            outline: none;
            border-color: #2563eb;
            box-shadow: 0 0 0 3px rgba(37, 99, 235, 0.1);
        }

        .recommendations {
            background-color: #fefce8;
            border: 1px solid #fde047;
            border-radius: 8px;
            padding: 24px;
            margin-bottom: 24px;
        }

        .recommendation-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(300px, 1fr));
            gap: 16px;
        }

        .keep-section {
            background-color: #f0fdf4;
            border: 1px solid #bbf7d0;
            border-radius: 6px;
            padding: 12px;
        }

        .remove-section {
            background-color: #fef2f2;
            border: 1px solid #fecaca;
            border-radius: 6px;
            padding: 12px;
        }

        .collapsible-section {
            border: 1px solid #e5e7eb;
            border-radius: 8px;
            margin-bottom: 16px;
            overflow: hidden;
            background-color: white;
            box-shadow: 0 2px 4px rgba(0, 0, 0, 0.05);
        }

        .collapsible-header {
            background-color: #f9fafb;
            padding: 12px 16px;
            cursor: pointer;
            display: flex;
            justify-content: space-between;
            align-items: center;
            font-weight: 600;
            transition: background-color 0.2s;
        }

        .collapsible-header:hover {
            background-color: #f3f4f6;
        }

        .collapsible-content {
            padding: 16px;
            display: none;
            border-top: 1px solid #e5e7eb;
        }

        .collapsible-content.expanded {
            display: block;
        }

        .dropdown-arrow {
            transition: transform 0.2s;
        }

        .dropdown-arrow.rotated {
            transform: rotate(180deg);
        }

        .analysis-control-panel {
            background-color: #fff;
            padding: 16px;
            border-radius: 8px;
            margin-bottom: 16px;
            border: 1px solid #e5e7eb;
        }

        .control-row {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(160px, 1fr));
            gap: 16px;
            align-items: end;
        }

        .control-group {
            display: flex;
            flex-direction: column;
            gap: 4px;
        }

        .control-label {
            font-size: 12px;
            font-weight: 500;
            color: #4b5563;
        }

        .quick-stats-bar {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(150px, 1fr));
            gap: 12px;
            margin-top: 16px;
            padding-top: 16px;
            border-top: 1px solid #e5e7eb;
        }

        .quick-stat {
            background-color: #f9fafb;
            padding: 8px 12px;
            border-radius: 6px;
            text-align: center;
        }

        .stat-value {
            font-size: 20px;
            font-weight: bold;
            color: #1f2937;
            display: block;
        }

        .stat-label {
            font-size: 12px;
            color: #6b7280;
        }

        .table-container {
            overflow-x: auto;
            margin-bottom: 24px;
            max-height: 600px;
            overflow-y: auto;
        }

        .table-filters {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(150px, 1fr));
            gap: 8px;
            margin-bottom: 12px;
            padding: 12px;
            background-color: #f9fafb;
            border-radius: 6px;
        }

        .pagination-controls {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin: 16px 0;
            padding: 12px;
            background-color: #f9fafb;
            border-radius: 6px;
        }

        table {
            width: 100%;
            border-collapse: collapse;
            border: 1px solid #d1d5db;
        }

        th,
        td {
            border: 1px solid #d1d5db;
            padding: 8px 12px;
            text-align: left;
        }

        th {
            background-color: #f9fafb;
            font-weight: 600;
            font-size: 14px;
            position: sticky;
            top: 0;
            z-index: 10;
        }

        td input,
        td select {
            width: 100%;
            padding: 4px 8px;
            border: 1px solid #e5e7eb;
            border-radius: 4px;
            font-size: 14px;
        }

        .duplicate-row {
            background-color: #fefce8;
        }

        .btn {
            padding: 8px 16px;
            border: none;
            border-radius: 6px;
            font-size: 14px;
            font-weight: 500;
            cursor: pointer;
            transition: all 0.2s;
        }

        .btn-primary {
            background-color: #2563eb;
            color: white;
        }

        .btn-primary:hover {
            background-color: #1d4ed8;
        }

        .btn-danger {
            background-color: #dc2626;
            color: white;
            padding: 4px 8px;
            font-size: 12px;
        }

        .btn-danger:hover {
            background-color: #b91c1c;
        }

        .btn-secondary {
            background-color: #6b7280;
            color: white;
            padding: 4px 8px;
            font-size: 12px;
        }

        .btn-secondary:hover {
            background-color: #4b5563;
        }

        .action-badge {
            padding: 4px 8px;
            border-radius: 12px;
            font-size: 12px;
            font-weight: 500;
            text-align: center;
        }

        .action-elite {
            background-color: #f0fdf4;
            color: #16a34a;
        }

        .action-strong {
            background-color: #eff6ff;
            color: #2563eb;
        }

        .action-weak {
            background-color: #fefce8;
            color: #ca8a04;
        }

        .action-remove {
            background-color: #fef2f2;
            color: #dc2626;
        }

        .section-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 16px;
        }

        .section-title {
            font-size: 18px;
            font-weight: 600;
        }

        .alert {
            padding: 12px;
            border-radius: 6px;
            margin-bottom: 16px;
        }

        .alert-warning {
            background-color: #fefce8;
            border: 1px solid #fde047;
            color: #92400e;
        }

        .text-small {
            font-size: 12px;
            color: #6b7280;
        }

        .metrics-details {
            font-size: 12px;
            color: #4b5563;
            margin-top: 6px;
        }

        .font-bold {
            font-weight: bold;
        }

        .text-center {
            text-align: center;
        }

        .hidden {
            display: none;
        }

        .file-stats {
            margin-top: 8px;
            padding: 8px 12px;
            background-color: #f0f9ff;
            border-radius: 4px;
            font-size: 14px;
            color: #1e40af;
        }
    </style>
</head>

<body>
    <div id="loadingOverlay" class="loading-overlay hidden">
        <div class="loading-content">
            <div class="loading-spinner"></div>
            <h3 id="loadingTitle">Processing Data...</h3>
            <p id="loadingMessage">Please wait while we process your file</p>
            <div class="progress-bar">
                <div id="progressFill" class="progress-fill" style="width: 0%"></div>
            </div>
            <p id="loadingDetails" class="text-small">Starting...</p>
        </div>
    </div>

    <div class="container">
        <div class="card">
            <div class="header">
                <svg class="icon" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2"
                        d="M9 7h6m0 10v-3m-3 3h.01M9 17h.01M9 14h.01M12 14h.01M15 11h.01M12 11h.01M9 11h.01M7 21h10a2 2 0 002-2V5a2 2 0 00-2 2v14a2 2 0 002 2z">
                    </path>
                </svg>
                <h1>Amazon Keyword Consolidation & Performance Calculator</h1>
            </div>

            <!-- Debug Mode Toggle -->
            <div
                style="display: flex; align-items: center; gap: 12px; padding: 12px; background-color: #f3f4f6; border-radius: 8px; margin-bottom: 16px;">
                <label
                    style="display: flex; align-items: center; gap: 8px; cursor: pointer; font-weight: 500; color: #374151;">
                    <input type="checkbox" id="debugModeToggle" style="width: 18px; height: 18px; cursor: pointer;">
                    <span>🔍 Debug Mode</span>
                </label>
                <span class="text-small" style="color: #6b7280;">Show detailed logging of duplicate detection</span>
            </div>

            <!-- Bulk File Upload Section -->
            <div class="upload-section" style="background-color: #fef3c7; border-color: #fcd34d;">
                <div class="upload-header">
                    <svg width="20" height="20" fill="none" stroke="#d97706" viewBox="0 0 24 24">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2"
                            d="M9 12h6m-6 4h6m2 5H7a2 2 0 01-2-2V5a2 2 0 012-2h5.586a1 1 0 01.707.293l5.414 5.414a1 1 0 01.293.707V19a2 2 0 01-2 2z">
                        </path>
                    </svg>
                    <h3 style="color: #92400e;">Upload Amazon Bulk File (Required for Export)</h3>
                </div>
                <input type="file" id="bulkFileInput" accept=".xlsx" class="file-input">
                <div class="text-small" style="margin-top: 8px; color: #92400e;">
                    Upload Amazon Advertising bulk file (.xlsx) to enable bulk export. Contains Campaign ID, Ad Group
                    ID, Keyword ID needed for pausing. <strong>You can also process duplicates using only this
                        file.</strong>
                </div>
                <div id="bulkFileStats" class="file-stats hidden" style="background-color: #fef9c3;"></div>
                <button id="processBulkOnlyBtn" class="btn btn-primary"
                    style="margin-top: 12px; background-color: #d97706; display: none;">
                    Process Bulk File Only (Skip Scale Insights)
                </button>
            </div>

            <!-- Scale Insights CSV Upload Section -->
            <div class="upload-section">
                <div class="upload-header">
                    <svg width="20" height="20" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2"
                            d="M7 16a4 4 0 01-.88-7.903A5 5 0 1115.9 6L16 6a5 5 0 011 9.9M15 13l-3-3m0 0l-3 3m3-3v12">
                        </path>
                    </svg>
                    <h3>Upload Scale Insights Keyword Data</h3>
                </div>
                <input type="file" id="fileInput" accept=".csv,.xlsx" class="file-input">
                <div class="text-small" style="margin-top: 8px;">
                    Expected columns: Campaign Name, Keyword, Sales, Conversion, ACOS, Orders, ASIN, Campaign Status,
                    Keyword Status
                </div>
                <div id="fileStats" class="file-stats hidden"></div>

                <div id="columnMapping" class="column-mapping">
                    <h4 style="margin-bottom: 8px; font-weight: 600;">Map Your Columns:</h4>
                    <div class="mapping-grid">
                        <div><label class="text-small font-bold">Campaign Name:</label><select id="campaignColumnSelect"
                                class="mapping-select">
                                <option value="">Select</option>
                            </select></div>
                        <div><label class="text-small font-bold">Keyword:</label><select id="keywordColumnSelect"
                                class="mapping-select">
                                <option value="">Select</option>
                            </select></div>
                        <div><label class="text-small font-bold">ASIN:</label><select id="asinColumnSelect"
                                class="mapping-select">
                                <option value="">Select</option>
                            </select></div>
                        <div><label class="text-small font-bold">Sales:</label><select id="salesColumnSelect"
                                class="mapping-select">
                                <option value="">Select</option>
                            </select></div>
                        <div><label class="text-small font-bold">Orders:</label><select id="ordersColumnSelect"
                                class="mapping-select">
                                <option value="">Select</option>
                            </select></div>
                        <div><label class="text-small font-bold">Conversion Rate:</label><select
                                id="conversionColumnSelect" class="mapping-select">
                                <option value="">Select</option>
                            </select></div>
                        <div><label class="text-small font-bold">ACOS:</label><select id="acosColumnSelect"
                                class="mapping-select">
                                <option value="">Select</option>
                            </select></div>
                        <div><label class="text-small font-bold">Match Type: <span
                                    style="color: #6b7280; font-weight: normal;">(Optional)</span></label><select
                                id="matchColumnSelect" class="mapping-select">
                                <option value="">Select</option>
                            </select></div>
                        <div><label class="text-small font-bold">Campaign Status:</label><select
                                id="campaignStatusColumnSelect" class="mapping-select">
                                <option value="">Select</option>
                            </select></div>
                        <div><label class="text-small font-bold">Keyword Status:</label><select
                                id="keywordStatusColumnSelect" class="mapping-select">
                                <option value="">Select</option>
                            </select></div>
                        <div style="display: flex; align-items: end;">
                            <button id="applyMappingBtn" class="btn btn-primary">Apply Mapping</button>
                        </div>
                    </div>
                </div>

                <!-- Zero Sales Keywords Section -->
                <div id="zeroSalesSection" style="margin-top: 20px; display: none;">
                    <div class="collapsible-section">
                        <div class="collapsible-header" onclick="calculator.toggleZeroSalesSection()"
                            style="background-color: #fef9c3; border-color: #fde047;">
                            <div style="display: flex; align-items: center; gap: 10px;">
                                <span style="color: #854d0e; font-weight: 600;">⚠️ Zero Sales Keywords</span>
                                <span id="zeroSalesCount" class="text-small" style="color: #a16207;">(0 keywords)</span>
                            </div>
                            <div class="dropdown-arrow" id="arrow-zero-sales">▼</div>
                        </div>
                        <div class="collapsible-content" id="content-zero-sales">
                            <p class="text-small" style="color: #854d0e; margin-bottom: 12px;">
                                These keywords have zero sales and are excluded from duplicate comparison. Review them
                                separately.
                            </p>
                            <div id="zeroSalesKeywordsList"></div>
                        </div>
                    </div>
                </div>
            </div>

            <div class="summary-grid">
                <div class="summary-card blue">
                    <div class="summary-content">
                        <div class="summary-label">Total Keywords</div>
                        <div class="summary-value" id="totalKeywords">0</div>
                    </div>
                </div>
                <div class="summary-card orange">
                    <div class="summary-content">
                        <div class="summary-label">Duplicate Keywords</div>
                        <div class="summary-value" id="duplicateCount">0</div>
                    </div>
                </div>
                <div class="summary-card red">
                    <div class="summary-content">
                        <div class="summary-label">Poor Performers</div>
                        <div class="summary-value" id="removeCount">0</div>
                    </div>
                </div>
                <div class="summary-card green">
                    <div class="summary-content">
                        <div class="summary-label">Potential Savings</div>
                        <div class="summary-value" id="potentialSavings">$0</div>
                    </div>
                </div>
            </div>

            <!-- Debug Panel - Data Storytelling UI -->
            <div id="debugPanel" class="card"
                style="display: none; background: #ffffff; border: 2px solid #0ea5e9; padding: 0;">

                <!-- Header -->
                <div
                    style="background: linear-gradient(135deg, #0ea5e9 0%, #0284c7 100%); padding: 20px; border-radius: 8px 8px 0 0;">
                    <div style="display: flex; justify-content: space-between; align-items: center;">
                        <h3 style="color: white; font-size: 20px; font-weight: 700; margin: 0;">🔍 Debug Mode - Data
                            Journey</h3>
                        <button class="btn btn-secondary" onclick="calculator.exportDebugLog()"
                            style="background: white; color: #0284c7; border: none;">📥 Export CSV</button>
                    </div>
                    <p style="color: #e0f2fe; font-size: 13px; margin: 8px 0 0 0;">See exactly what happens to your data
                        from upload to final decision</p>
                </div>

                <div style="padding: 24px;">

                    <!-- Chapter 1: Upload Summary (Always Visible) -->
                    <div class="debug-chapter"
                        style="margin-bottom: 20px; border: 2px solid #dbeafe; border-radius: 8px; background: linear-gradient(135deg, #f0f9ff 0%, #e0f2fe 100%);">
                        <div style="padding: 16px; border-bottom: 1px solid #bfdbfe;">
                            <h4 style="color: #0c4a6e; font-size: 16px; font-weight: 600; margin: 0;">📊 Chapter 1:
                                Upload Summary</h4>
                            <p style="color: #075985; font-size: 12px; margin: 4px 0 0 0;">Complete overview of data
                                processing</p>
                        </div>
                        <div style="padding: 16px;">
                            <div class="summary-grid"
                                style="display: grid; grid-template-columns: repeat(auto-fit, minmax(140px, 1fr)); gap: 12px;">
                                <div
                                    style="background: white; padding: 12px; border-radius: 6px; border: 1px solid #bfdbfe;">
                                    <div style="font-size: 11px; color: #0369a1; font-weight: 600;">✓ UPLOADED</div>
                                    <div id="debugTotalUploaded"
                                        style="font-size: 24px; color: #0c4a6e; font-weight: 700;">0</div>
                                </div>
                                <div
                                    style="background: white; padding: 12px; border-radius: 6px; border: 1px solid #fed7aa;">
                                    <div style="font-size: 11px; color: #9a3412; font-weight: 600;">⚠️ FILTERED</div>
                                    <div id="debugFiltered" style="font-size: 24px; color: #7c2d12; font-weight: 700;">0
                                    </div>
                                </div>
                                <div
                                    style="background: white; padding: 12px; border-radius: 6px; border: 1px solid #fde68a;">
                                    <div style="font-size: 11px; color: #92400e; font-weight: 600;">⏭️ SKIPPED</div>
                                    <div id="debugZeroSales" style="font-size: 24px; color: #78350f; font-weight: 700;">
                                        0</div>
                                </div>
                                <div
                                    style="background: white; padding: 12px; border-radius: 6px; border: 1px solid #93c5fd;">
                                    <div style="font-size: 11px; color: #1e40af; font-weight: 600;">✓ PROCESSED</div>
                                    <div id="debugTotalProcessed"
                                        style="font-size: 24px; color: #1e3a8a; font-weight: 700;">0</div>
                                </div>
                            </div>
                            <div style="margin-top: 12px; padding-top: 12px; border-top: 1px solid #bfdbfe;">
                                <div style="font-size: 12px; color: #0c4a6e; font-weight: 600; margin-bottom: 8px;">📈
                                    Results:</div>
                                <div style="display: flex; gap: 20px; font-size: 12px; color: #075985;">
                                    <span>Duplicate Groups: <strong id="debugDuplicateGroups">0</strong></span>
                                    <span>To Pause: <strong id="debugMarkedForRemoval">0</strong></span>
                                    <span>Unique Keywords: <strong id="debugUniqueCount">0</strong></span>
                                </div>
                            </div>
                        </div>
                    </div>

                    <!-- Chapter 2: Filtered Rows -->
                    <div class="debug-chapter" style="margin-bottom: 16px;">
                        <div class="chapter-header" onclick="calculator.toggleChapter('filtered')"
                            style="background: #fef3c7; padding: 12px 16px; border-radius: 6px; cursor: pointer; border: 1px solid #fde68a;">
                            <div style="display: flex; justify-content: space-between; align-items: center;">
                                <div>
                                    <span style="font-size: 16px; font-weight: 600; color: #92400e;">⚠️ Chapter 2:
                                        Filtered Rows</span>
                                    <span id="filteredCount" style="color: #a16207; margin-left: 8px;">(0 rows)</span>
                                </div>
                                <span id="filteredToggle" style="color: #92400e; font-size: 18px;">▼</span>
                            </div>
                            <p style="font-size: 12px; color: #78350f; margin: 4px 0 0 0;">Why excluded? Missing keyword
                                or ASIN data</p>
                        </div>
                        <div id="chapterFiltered" class="chapter-content"
                            style="display: none; padding: 16px; background: white; border: 1px solid #fde68a; border-top: none; border-radius: 0 0 6px 6px;">
                            <p style="font-size: 13px; color: #78350f; margin-bottom: 12px;">These rows were removed
                                before analysis because they're missing critical data.</p>
                            <div id="filteredTable"></div>
                        </div>
                    </div>

                    <!-- Chapter 3: Skipped Keywords -->
                    <div class="debug-chapter" style="margin-bottom: 16px;">
                        <div class="chapter-header" onclick="calculator.toggleChapter('skipped')"
                            style="background: #fef9c3; padding: 12px 16px; border-radius: 6px; cursor: pointer; border: 1px solid #fde047;">
                            <div style="display: flex; justify-content: space-between; align-items: center;">
                                <div>
                                    <span style="font-size: 16px; font-weight: 600; color: #854d0e;">⏭️ Chapter 3:
                                        Skipped Keywords</span>
                                    <span id="skippedCount" style="color: #a16207; margin-left: 8px;">(0 rows)</span>
                                </div>
                                <span id="skippedToggle" style="color: #854d0e; font-size: 18px;">▼</span>
                            </div>
                            <p style="font-size: 12px; color: #a16207; margin: 4px 0 0 0;">Why skipped? Zero or empty
                                sales data</p>
                        </div>
                        <div id="chapterSkipped" class="chapter-content"
                            style="display: none; padding: 16px; background: white; border: 1px solid #fde047; border-top: none; border-radius: 0 0 6px 6px;">
                            <p style="font-size: 13px; color: #a16207; margin-bottom: 12px;">These keywords have no
                                sales, so they can't be compared for duplicates.</p>
                            <div id="skippedTable"></div>
                        </div>
                    </div>

                    <!-- Chapter 4: Analysis & Grouping -->
                    <div class="debug-chapter" style="margin-bottom: 16px;">
                        <div class="chapter-header" onclick="calculator.toggleChapter('analysis')"
                            style="background: #f5f3ff; padding: 12px 16px; border-radius: 6px; cursor: pointer; border: 1px solid #ddd6fe;">
                            <div style="display: flex; justify-content: space-between; align-items: center;">
                                <div>
                                    <span style="font-size: 16px; font-weight: 600; color: #5b21b6;">🔍 Chapter 4:
                                        Analysis & Grouping</span>
                                    <span id="analysisCount" style="color: #7c3aed; margin-left: 8px;">(0
                                        keywords)</span>
                                </div>
                                <span id="analysisToggle" style="color: #5b21b6; font-size: 18px;">▼</span>
                            </div>
                            <p style="font-size: 12px; color: #6d28d9; margin: 4px 0 0 0;">How analyzed? Scoring,
                                campaign parsing, grouping by match type</p>
                        </div>
                        <div id="chapterAnalysis" class="chapter-content"
                            style="display: none; padding: 16px; background: white; border: 1px solid #ddd6fe; border-top: none; border-radius: 0 0 6px 6px;">
                            <div id="analysisDetails"></div>
                        </div>
                    </div>

                    <!-- Chapter 5: Final Decisions -->
                    <div class="debug-chapter" style="margin-bottom: 16px;">
                        <div class="chapter-header" onclick="calculator.toggleChapter('decisions')"
                            style="background: #dcfce7; padding: 12px 16px; border-radius: 6px; cursor: pointer; border: 1px solid #86efac;">
                            <div style="display: flex; justify-content: space-between; align-items: center;">
                                <div>
                                    <span style="font-size: 16px; font-weight: 600; color: #15803d;">✅ Chapter 5: Final
                                        Decisions</span>
                                    <span id="decisionsCount" style="color: #16a34a; margin-left: 8px;">(0
                                        groups)</span>
                                </div>
                                <span id="decisionsToggle" style="color: #15803d; font-size: 18px;">▼</span>
                            </div>
                            <p style="font-size: 12px; color: #16a34a; margin: 4px 0 0 0;">What to pause? Keywords with
                                lower scores in duplicate groups</p>
                        </div>
                        <div id="chapterDecisions" class="chapter-content"
                            style="display: none; padding: 16px; background: white; border: 1px solid #86efac; border-top: none; border-radius: 0 0 6px 6px;">
                            <div id="decisionsTable"></div>
                        </div>
                    </div>

                </div>
            </div>

            <div id="recommendationsSection" class="recommendations" style="display: none;">
                <h3 class="section-title" style="color: #92400e; margin-bottom: 16px;">
                    🚨 Consolidation Recommendations & Analysis
                </h3>

                <div class="analysis-control-panel">
                    <div class="control-row">
                        <div class="control-group"><label class="control-label">🔍 Search Keywords</label><input
                                type="text" id="duplicateSearchFilter" placeholder="Search..." class="control-input">
                        </div>
                        <div class="control-group"><label class="control-label">🛍️ ASIN</label><select id="asinFilter"
                                class="control-input">
                                <option value="">All ASINs</option>
                            </select></div>
                        <div class="control-group"><label class="control-label">📊 Min. Campaigns</label><select
                                id="minCampaignsFilter" class="control-input">
                                <option value="2">2+ Campaigns</option>
                                <option value="3">3+</option>
                                <option value="4">4+</option>
                            </select></div>
                        <div class="control-group"><label class="control-label">📈 Sort By</label><select
                                id="duplicateSortFilter" class="control-input">
                                <option value="savings-desc">Highest Savings</option>
                                <option value="campaigns-desc">Most Campaigns</option>
                                <option value="keyword-asc">Keyword A-Z</option>
                            </select></div>
                        <div class="control-group"><label class="control-label">⚡ Status</label><select
                                id="statusFilter" class="control-input">
                                <option value="">All Statuses</option>
                                <option value="enabled">Enabled Keywords Only</option>
                                <option value="campaign_enabled">Enabled Campaigns Only</option>
                            </select></div>
                        <div class="control-group"><label class="control-label">🎯 Campaign Type</label><select
                                id="campaignTypeFilter" class="control-input">
                                <option value="">All Types</option>
                                <option value="SP Auto">SP Auto</option>
                                <option value="SP Manual">SP Manual</option>
                                <option value="SB Video">SB Video</option>
                                <option value="SD Display">SD Display</option>
                            </select></div>
                        <div class="control-group"><label class="control-label">⚙️ Options</label>
                            <div style="display:flex; align-items:center; height: 37px;"><input type="checkbox"
                                    id="excludeSingleOrderFilter" style="margin-right: 8px;"><label
                                    for="excludeSingleOrderFilter" class="text-small">Exclude 1-Order KWs</label></div>
                        </div>
                    </div>
                    <div class="quick-stats-bar">
                        <div class="quick-stat"><span class="stat-value" id="totalDuplicatesFound">0</span><span
                                class="stat-label">Filtered Duplicates</span></div>
                        <div class="quick-stat"><span class="stat-value" id="campaignsToOptimize">0</span><span
                                class="stat-label">Keywords to Pause</span></div>
                        <div class="quick-stat"><span class="stat-value" id="totalWastedSpend">$0</span><span
                                class="stat-label">Total Waste</span></div>
                    </div>
                </div>

                <div id="recommendationsList" style="margin-top: 16px;"></div>

                <div class="pagination-controls" id="duplicatesPagination" style="display: none;">
                    <div><span>Showing <span id="duplicatesShowingStart">0</span>-<span
                                id="duplicatesShowingEnd">0</span> of <span id="duplicatesTotalFiltered">0</span></span>
                    </div>
                    <div><label class="text-small">Per page:</label><select id="duplicatesRowsPerPage"
                            style="margin-left: 8px; margin-right: 16px;">
                            <option value="5">5</option>
                            <option value="10" selected>10</option>
                            <option value="20">20</option>
                        </select><button id="duplicatesPrevPageBtn" class="btn btn-secondary">Previous</button><button
                            id="duplicatesNextPageBtn" class="btn btn-secondary" style="margin-left: 8px;">Next</button>
                    </div>

                    <!-- Generate Bulk File Button -->
                    <div id="exportSection"
                        style="margin-top: 20px; padding: 16px; background-color: #f0fdf4; border: 1px solid #bbf7d0; border-radius: 8px;">
                        <div
                            style="display: flex; justify-content: space-between; align-items: center; flex-wrap: wrap; gap: 12px;">
                            <div>
                                <p style="font-weight: 600; color: #166534; margin-bottom: 4px;">📥 Export Selected
                                    Keywords to Pause</p>
                                <p id="exportMessage" class="text-small" style="color: #15803d;">Upload a bulk file to
                                    enable export functionality.</p>
                            </div>
                            <div style="display: flex; gap: 12px; align-items: center;">
                                <span id="selectedCount" class="text-small" style="color: #166534;">0 keywords
                                    selected</span>
                                <button id="generateBulkFileBtn" class="btn btn-primary"
                                    style="background-color: #16a34a;" disabled>Generate Pause Bulk File</button>
                            </div>
                        </div>
                    </div>
                </div>

                <div class="weights-section">
                    <h3 class="section-title" style="margin-bottom: 16px;">Scoring Weights Configuration</h3>
                    <div class="weights-grid">
                        <div><label class="text-small font-bold">ACOS Weight (%)</label><input type="number"
                                id="acosWeight" value="45" min="0" max="100" class="weight-input"></div>
                        <div><label class="text-small font-bold">Conversion Weight (%)</label><input type="number"
                                id="conversionWeight" value="35" min="0" max="100" class="weight-input"></div>
                        <div><label class="text-small font-bold">Sales Weight (%)</label><input type="number"
                                id="salesWeight" value="20" min="0" max="100" class="weight-input"></div>
                    </div>
                    <div class="text-small" style="margin-top: 8px;"><span id="weightTotal">Total: 100%</span><span
                            id="weightWarning" style="color: #dc2626; display: none;"> ⚠️ Weights should total
                            100%</span>
                    </div>
                </div>

            </div>
        </div>

        <script>
            class KeywordCalculator {
                constructor() {
                    this.keywords = [];
                    this.weights = { acos: 45, conversion: 35, sales: 20 };
                    this.results = [];
                    this.filteredDuplicates = [];
                    this.duplicates = {};
                    this.rawData = null;
                    this.uniqueAsins = new Set();

                    // Bulk file data storage
                    this.bulkFileData = null;
                    this.bulkFileWorksheets = {};
                    this.selectedKeywordsToPause = new Map();
                    this.zeroSalesKeywords = [];

                    // Debug Mode state
                    this.debugMode = false;
                    this.debugLog = [];
                    this.totalUploadedRows = 0; // Track total rows uploaded
                    this.filteredRowsCount = 0; // Track filtered rows

                    this.duplicatesCurrentPage = 1;
                    this.duplicatesRowsPerPage = 10;

                    this.initializeEventListeners();
                }

                initializeEventListeners() {
                    document.getElementById('fileInput').addEventListener('change', (e) => this.handleFileUpload(e));
                    document.getElementById('bulkFileInput').addEventListener('change', (e) => this.handleBulkFileUpload(e));
                    document.getElementById('applyMappingBtn').addEventListener('click', () => this.applyColumnMapping());
                    document.getElementById('generateBulkFileBtn').addEventListener('click', () => this.generatePauseBulkFile());
                    document.getElementById('processBulkOnlyBtn').addEventListener('click', () => this.processBulkFileOnly());

                    ['acosWeight', 'conversionWeight', 'salesWeight'].forEach(id => {
                        document.getElementById(id).addEventListener('input', (e) => this.updateWeight(id, e.target.value));
                    });

                    // Debug Mode toggle listener
                    document.getElementById('debugModeToggle').addEventListener('change', (e) => {
                        this.debugMode = e.target.checked;
                        document.getElementById('debugPanel').style.display = this.debugMode ? 'block' : 'none';
                        if (!this.debugMode) this.debugLog = [];
                    });

                    // Consolidation filter listeners
                    const recommendationFilters = ['duplicateSearchFilter', 'asinFilter', 'minCampaignsFilter', 'duplicateSortFilter', 'statusFilter', 'campaignTypeFilter', 'excludeSingleOrderFilter'];
                    recommendationFilters.forEach(id => {
                        document.getElementById(id).addEventListener('input', () => this.renderRecommendations());
                    });

                    // Duplicate pagination listeners
                    document.getElementById('duplicatesRowsPerPage').addEventListener('change', (e) => {
                        this.duplicatesRowsPerPage = parseInt(e.target.value);
                        this.duplicatesCurrentPage = 1;
                        this.renderRecommendations();
                    });

                    document.getElementById('duplicatesPrevPageBtn').addEventListener('click', () => {
                        if (this.duplicatesCurrentPage > 1) {
                            this.duplicatesCurrentPage--;
                            this.renderRecommendations();
                        }
                    });

                    document.getElementById('duplicatesNextPageBtn').addEventListener('click', () => {
                        const totalPages = Math.ceil(this.filteredDuplicates.length / this.duplicatesRowsPerPage);
                        if (this.duplicatesCurrentPage < totalPages) {
                            this.duplicatesCurrentPage++;
                            this.renderRecommendations();
                        }
                    });
                }

                showLoading(title, message) {
                    document.getElementById('loadingTitle').textContent = title;
                    document.getElementById('loadingMessage').textContent = message;
                    document.getElementById('loadingOverlay').classList.remove('hidden');
                }

                updateProgress(percent, details) {
                    document.getElementById('progressFill').style.width = percent + '%';
                    document.getElementById('loadingDetails').textContent = details;
                }

                hideLoading() {
                    document.getElementById('loadingOverlay').classList.add('hidden');
                }

                // Handle Amazon Bulk File Upload with Web Worker for performance
                async handleBulkFileUpload(event) {
                    const file = event.target.files[0];
                    if (!file) return;

                    this.showLoading('Reading Bulk File', 'Starting file processing...');
                    const fileSize = (file.size / 1024 / 1024).toFixed(2);
                    const fileName = file.name;

                    try {
                        this.updateProgress(10, 'Reading file into memory...');
                        const arrayBuffer = await file.arrayBuffer();

                        this.updateProgress(20, 'Starting background parser...');

                        // Create inline Web Worker for XLSX parsing
                        const workerCode = `
                            // Load XLSX library in worker
                            importScripts('https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js');
                            
                            self.onmessage = function(e) {
                                try {
                                    const arrayBuffer = e.data;
                                    
                                    self.postMessage({ type: 'progress', message: 'Parsing Excel file...', percent: 30 });
                                    
                                    const workbook = XLSX.read(arrayBuffer, { type: 'array' });
                                    
                                    self.postMessage({ type: 'progress', message: 'Processing worksheets...', percent: 60 });
                                    
                                    const worksheets = {};
                                    let totalKeywords = 0;
                                    let totalProductTargeting = 0;
                                    
                                    workbook.SheetNames.forEach((sheetName, idx) => {
                                        const percent = 60 + Math.floor((idx / workbook.SheetNames.length) * 30);
                                        self.postMessage({ type: 'progress', message: 'Processing ' + sheetName + '...', percent: percent });
                                        
                                        const sheetData = XLSX.utils.sheet_to_json(workbook.Sheets[sheetName], { defval: '' });
                                        if (sheetData.length > 0) {
                                            const filteredData = sheetData.filter(row => {
                                                const entity = String(row['Entity'] || '').toLowerCase();
                                                return entity === 'keyword' || entity === 'product targeting';
                                            });
                                            
                                            if (filteredData.length > 0) {
                                                worksheets[sheetName] = {
                                                    allData: sheetData,
                                                    headers: Object.keys(sheetData[0]),
                                                    keywordData: filteredData
                                                };
                                                
                                                filteredData.forEach(row => {
                                                    const entity = String(row['Entity'] || '').toLowerCase();
                                                    if (entity === 'keyword') totalKeywords++;
                                                    else if (entity === 'product targeting') totalProductTargeting++;
                                                });
                                            }
                                        }
                                    });
                                    
                                    self.postMessage({ 
                                        type: 'complete', 
                                        worksheets: worksheets,
                                        sheetNames: workbook.SheetNames,
                                        totalKeywords: totalKeywords,
                                        totalProductTargeting: totalProductTargeting
                                    });
                                    
                                } catch (error) {
                                    self.postMessage({ type: 'error', message: error.message });
                                }
                            };
                        `;

                        const blob = new Blob([workerCode], { type: 'application/javascript' });
                        const workerUrl = URL.createObjectURL(blob);
                        const worker = new Worker(workerUrl);

                        // Handle worker messages
                        worker.onmessage = (e) => {
                            const data = e.data;

                            if (data.type === 'progress') {
                                this.updateProgress(data.percent, data.message);
                            } else if (data.type === 'complete') {
                                // Store the parsed data
                                this.bulkFileWorksheets = data.worksheets;
                                this.bulkFileData = { SheetNames: data.sheetNames }; // Minimal workbook reference

                                document.getElementById('bulkFileStats').innerHTML = `✅ Bulk file loaded: ${fileName} (${fileSize} MB)<br>📊 Found ${Object.keys(data.worksheets).length} worksheets with ${data.totalKeywords} keywords and ${data.totalProductTargeting} product targeting entries`;
                                document.getElementById('bulkFileStats').classList.remove('hidden');
                                document.getElementById('generateBulkFileBtn').disabled = false;
                                document.getElementById('exportMessage').textContent = 'Bulk file loaded. Select keywords to pause and click Generate.';
                                document.getElementById('processBulkOnlyBtn').style.display = 'block';

                                this.hideLoading();
                                this.updateSelectedCount();

                                // Cleanup
                                worker.terminate();
                                URL.revokeObjectURL(workerUrl);
                            } else if (data.type === 'error') {
                                console.error('Worker error:', data.message);
                                alert('Error processing bulk file: ' + data.message);
                                this.hideLoading();
                                worker.terminate();
                                URL.revokeObjectURL(workerUrl);
                            }
                        };

                        worker.onerror = (error) => {
                            console.error('Worker error:', error);
                            alert('Error processing bulk file. Please try again.');
                            this.hideLoading();
                            worker.terminate();
                            URL.revokeObjectURL(workerUrl);
                        };

                        // Start the worker with the file data
                        worker.postMessage(arrayBuffer, [arrayBuffer]);

                    } catch (error) {
                        console.error('Error processing bulk file:', error);
                        alert('Error processing bulk file. Please check the format and try again.');
                        this.hideLoading();
                    }
                    event.target.value = '';
                }

                // Process bulk file data only (without Scale Insights)
                async processBulkFileOnly() {
                    if (!this.bulkFileData || Object.keys(this.bulkFileWorksheets).length === 0) {
                        alert('Please upload a bulk file first.');
                        return;
                    }

                    this.showLoading('Processing Bulk File', 'Building ASIN lookup maps...');

                    try {
                        this.keywords = [];
                        let idCounter = 1;

                        // Step 1: Build ASIN lookup maps for each worksheet
                        // For SP: Campaign ID -> ASIN (from Product Ad entity row)
                        // For SB: Campaign ID -> Creative ASINs (from Campaign entity row)
                        const asinMaps = {};
                        const sbCampaignNames = new Set(); // For SB deduplication

                        this.updateProgress(10, 'Building ASIN lookup maps...');

                        for (const [sheetName, sheet] of Object.entries(this.bulkFileWorksheets)) {
                            const allData = sheet.allData;
                            const isSP = sheetName.toLowerCase().includes('sponsored products');
                            const isSB = sheetName.toLowerCase().includes('sponsored brands') && !sheetName.toLowerCase().includes('multi');
                            const isSBMulti = sheetName.toLowerCase().includes('multi ad group');

                            asinMaps[sheetName] = {};

                            // Build Campaign ID -> ASIN map
                            allData.forEach(row => {
                                const entity = String(row['Entity'] || '').toLowerCase();
                                const campaignId = String(row['Campaign ID'] || row['Campaign Id'] || '');

                                if (!campaignId) return;

                                if (isSP && entity === 'product ad') {
                                    // For SP: get ASIN from Product Ad row
                                    const asin = String(row['ASIN (Informational only)'] || row['ASIN'] || '');
                                    if (asin && !asinMaps[sheetName][campaignId]) {
                                        asinMaps[sheetName][campaignId] = asin;
                                    }
                                } else if ((isSB || isSBMulti) && entity === 'campaign') {
                                    // For SB: get Creative ASINs from Campaign row
                                    const creativeAsins = String(row['Creative ASINs'] || row['Creative ASIN'] || '');
                                    if (creativeAsins) {
                                        asinMaps[sheetName][campaignId] = creativeAsins;
                                    }

                                    // Track SB campaign names for deduplication
                                    if (isSB) {
                                        const campaignName = String(row['Campaign Name (Informational only)'] || row['Campaign Name'] || '').toLowerCase().trim();
                                        if (campaignName) {
                                            sbCampaignNames.add(campaignName);
                                        }
                                    }
                                }
                            });
                        }

                        this.updateProgress(30, 'Processing keywords from worksheets...');

                        // Step 2: Sort worksheets - prioritize SP and main SB over Multi Ad Group
                        const sortedSheets = Object.entries(this.bulkFileWorksheets).sort(([nameA], [nameB]) => {
                            const getPriority = (name) => {
                                const lower = name.toLowerCase();
                                if (lower.includes('sponsored products')) return 1;
                                if (lower.includes('sponsored brands') && !lower.includes('multi')) return 2;
                                if (lower.includes('multi ad group')) return 4;
                                return 3;
                            };
                            return getPriority(nameA) - getPriority(nameB);
                        });

                        // Step 3: Process keywords from each worksheet
                        let processedCount = 0;
                        const totalRows = sortedSheets.reduce((sum, [_, sheet]) => sum + sheet.keywordData.length, 0);

                        for (const [sheetName, sheet] of sortedSheets) {
                            if (sheet.keywordData.length === 0) continue;

                            const isSBMulti = sheetName.toLowerCase().includes('multi ad group');
                            const headers = sheet.headers;
                            const columnMap = this.findColumnsSmartly(headers);
                            const sheetAsinMap = asinMaps[sheetName] || {};

                            // Process in chunks to prevent UI freeze
                            const chunkSize = 500;
                            for (let i = 0; i < sheet.keywordData.length; i += chunkSize) {
                                const chunk = sheet.keywordData.slice(i, i + chunkSize);

                                chunk.forEach(row => {
                                    const entity = String(row['Entity'] || '').toLowerCase();
                                    const campaignId = String(row['Campaign ID'] || row['Campaign Id'] || '');

                                    // Get campaign name (prefer informational column)
                                    const campaignName = this.getColumnValue(row, columnMap.campaignNameInfo) ||
                                        this.getColumnValue(row, columnMap.campaignName) || '';

                                    // SB Deduplication: Skip if this is Multi Ad Group and campaign exists in main SB
                                    if (isSBMulti && sbCampaignNames.has(campaignName.toLowerCase().trim())) {
                                        return; // Skip this keyword - already processed from main SB sheet
                                    }

                                    // Get keyword text or product targeting expression
                                    let keywordText = '';
                                    let targetAsin = '';

                                    if (entity === 'keyword') {
                                        keywordText = this.getColumnValue(row, columnMap.keywordText) || '';
                                    } else if (entity === 'product targeting') {
                                        const targetingExpr = this.getColumnValue(row, columnMap.productTargeting) || '';
                                        const asinMatch = targetingExpr.match(/asin="([^"]+)"/i);
                                        if (asinMatch) {
                                            targetAsin = asinMatch[1];
                                            keywordText = targetAsin;
                                        } else {
                                            keywordText = targetingExpr;
                                        }
                                    }

                                    // Get ASIN from lookup map (via Campaign ID)
                                    const productAsin = sheetAsinMap[campaignId] || '';

                                    const adGroupName = this.getColumnValue(row, columnMap.adGroupNameInfo) ||
                                        this.getColumnValue(row, columnMap.adGroupName) || '';
                                    const matchType = this.getColumnValue(row, columnMap.matchType) || 'Unknown';

                                    // Collect metrics
                                    const allMetrics = {};
                                    columnMap.metrics.forEach(metricCol => {
                                        const value = parseFloat(row[metricCol] || 0);
                                        if (!isNaN(value)) {
                                            allMetrics[metricCol] = value;
                                        }
                                    });

                                    const sales = allMetrics['Sales'] || allMetrics['7 Day Total Sales'] || 0;
                                    const spend = allMetrics['Spend'] || allMetrics['Cost'] || 0;
                                    const clicks = allMetrics['Clicks'] || 0;
                                    const impressions = allMetrics['Impressions'] || 0;
                                    const orders = allMetrics['Orders'] || allMetrics['7 Day Total Orders (#)'] || 0;
                                    const acos = sales > 0 ? (spend / sales) * 100 : 0;
                                    const conversion = clicks > 0 ? (orders / clicks) * 100 : 0;

                                    if (keywordText && campaignName) {
                                        this.keywords.push({
                                            id: `bulk_${idCounter++}`,
                                            name: keywordText,
                                            asin: productAsin,
                                            targetAsin: targetAsin,
                                            campaign: campaignName,
                                            adGroup: adGroupName,
                                            matchType: matchType,
                                            entityType: entity,
                                            sales: sales,
                                            acos: acos,
                                            conversion: conversion,
                                            impressions: impressions,
                                            clicks: clicks,
                                            orders: orders,
                                            spend: spend,
                                            allMetrics: allMetrics,
                                            sheetName: sheetName,
                                            campaignId: campaignId
                                        });
                                    }
                                });

                                processedCount += chunk.length;
                                const progress = 30 + Math.floor((processedCount / totalRows) * 40);
                                this.updateProgress(progress, `Processing row ${processedCount} of ${totalRows}...`);

                                // Yield to UI every chunk to prevent freeze
                                await new Promise(resolve => setTimeout(resolve, 0));
                            }
                        }

                        if (this.keywords.length === 0) {
                            alert('No keyword data found in the bulk file. Please check the file format.');
                            this.hideLoading();
                            return;
                        }

                        this.updateProgress(75, `Calculating scores for ${this.keywords.length} keywords...`);
                        await new Promise(resolve => setTimeout(resolve, 0));

                        // Calculate composite scores
                        this.keywords.forEach(kw => {
                            const acosScore = kw.acos > 0 ? Math.max(0, 100 - kw.acos) : 50;
                            const convScore = Math.min(100, kw.conversion * 5);
                            const salesScore = Math.min(100, (kw.sales / 100) * 100);

                            const weights = this.weights;
                            const totalWeight = weights.acos + weights.conversion + weights.sales;

                            const compositeScore = (
                                (acosScore * weights.acos / 100) +
                                (convScore * weights.conversion / 100) +
                                (salesScore * weights.sales / 100)
                            ) * (100 / totalWeight);

                            kw.compositeScore = compositeScore.toFixed(1);
                        });

                        this.results = this.keywords;

                        this.updateProgress(85, 'Identifying duplicates...');
                        await new Promise(resolve => setTimeout(resolve, 0));

                        this.identifyDuplicates();

                        this.updateProgress(95, 'Rendering recommendations...');
                        await new Promise(resolve => setTimeout(resolve, 0));

                        this.updateSummary();
                        document.getElementById('recommendationsSection').style.display = 'block';

                        this.hideLoading();

                        const dupCount = Object.keys(this.duplicates).length;
                        const skippedCount = sbCampaignNames.size > 0 ? ` (Deduplicated ${sbCampaignNames.size} SB campaigns)` : '';
                        alert(`Successfully processed ${this.keywords.length} keywords from bulk file.${skippedCount}\n\nFound ${dupCount} duplicate groups.`);

                    } catch (error) {
                        console.error('Error processing bulk file:', error);
                        alert('Error processing bulk file: ' + error.message);
                        this.hideLoading();
                    }
                }

                // Smart column finder - finds columns by keyword matching
                findColumnsSmartly(headers) {
                    const columnMap = {
                        keywordText: null,
                        campaignName: null,
                        campaignNameInfo: null,
                        adGroupName: null,
                        adGroupNameInfo: null,
                        asin: null,
                        matchType: null,
                        productTargeting: null,
                        metrics: []
                    };

                    const metricKeywords = ['sales', 'spend', 'cost', 'clicks', 'impressions', 'orders', 'ctr', 'cpc', 'acos', 'roas', 'conversions'];

                    headers.forEach(header => {
                        const h = header.toLowerCase();

                        // Keyword Text
                        if (h.includes('keyword') && h.includes('text') && !columnMap.keywordText) {
                            columnMap.keywordText = header;
                        }

                        // Campaign Name (Informational)
                        if (h.includes('campaign') && h.includes('name') && h.includes('informational')) {
                            columnMap.campaignNameInfo = header;
                        } else if (h.includes('campaign') && h.includes('name') && !h.includes('informational') && !columnMap.campaignName) {
                            columnMap.campaignName = header;
                        }

                        // Ad Group Name (Informational)
                        if (h.includes('ad group') && h.includes('name') && h.includes('informational')) {
                            columnMap.adGroupNameInfo = header;
                        } else if (h.includes('ad group') && h.includes('name') && !h.includes('informational') && !columnMap.adGroupName) {
                            columnMap.adGroupName = header;
                        }

                        // ASIN (your product)
                        if (h.includes('asin') && h.includes('informational') && !columnMap.asin) {
                            columnMap.asin = header;
                        }

                        // Match Type
                        if (h.includes('match') && h.includes('type') && !columnMap.matchType) {
                            columnMap.matchType = header;
                        }

                        // Product Targeting Expression
                        if (h.includes('product') && h.includes('targeting') && h.includes('expression') && !h.includes('resolved')) {
                            columnMap.productTargeting = header;
                        }

                        // Detect metrics columns
                        for (const keyword of metricKeywords) {
                            if (h.includes(keyword) && !columnMap.metrics.includes(header)) {
                                columnMap.metrics.push(header);
                                break;
                            }
                        }
                    });

                    return columnMap;
                }

                // Helper to get column value safely
                getColumnValue(row, columnName) {
                    if (!columnName) return null;
                    return row[columnName] !== undefined ? String(row[columnName]) : null;
                }

                // Extract product+variation, campaign type, and match type from campaign name
                parseCampaignName(campaignName) {
                    const parts = campaignName.split('|').map(p => p.trim());
                    const productVariation = parts[0] || '';

                    let campaignType = 'Other';
                    let matchType = 'Unknown';

                    // Search through all segments for campaign type and match type
                    parts.forEach(segment => {
                        const seg = segment.toUpperCase();

                        // Detect campaign type
                        if (campaignType === 'Other') {
                            if (seg.includes('SP')) campaignType = 'SP';
                            else if (seg.includes('SB')) campaignType = 'SB';
                            else if (seg.includes('SD')) campaignType = 'SD';
                        }

                        // Detect match type (smart detection - search all segments)
                        if (matchType === 'Unknown') {
                            if (seg.includes('BROAD')) matchType = 'Broad';
                            else if (seg.includes('PHRASE')) matchType = 'Phrase';
                            else if (seg.includes('EXACT')) matchType = 'Exact';
                            else if (seg.includes('AUTO')) matchType = 'Auto';
                        }
                    });

                    return {
                        productVariation: productVariation.toLowerCase(),
                        campaignType,
                        matchType
                    };
                }

                // Update selected count display
                updateSelectedCount() {
                    const count = this.selectedKeywordsToPause.size;
                    document.getElementById('selectedCount').textContent = `${count} keywords selected`;
                }

                // Toggle keyword selection
                toggleKeywordSelection(keywordId, isChecked) {
                    if (isChecked) {
                        this.selectedKeywordsToPause.set(keywordId, true);
                    } else {
                        this.selectedKeywordsToPause.delete(keywordId);
                    }
                    this.updateSelectedCount();
                }

                async handleFileUpload(event) {
                    const file = event.target.files[0];
                    if (!file) return;

                    // Auto-enable Debug Mode to capture all processing steps
                    this.debugMode = true;
                    this.debugLog = []; // Initialize debug log for new upload
                    document.getElementById('debugModeToggle').checked = true;
                    document.getElementById('debugPanel').style.display = 'block';

                    this.showLoading('Reading File', 'Processing your upload...');
                    try {
                        const fileSize = (file.size / 1024 / 1024).toFixed(2);
                        document.getElementById('fileStats').innerHTML = `File: ${file.name} (${fileSize} MB)`;
                        document.getElementById('fileStats').classList.remove('hidden');
                        this.updateProgress(25, 'Reading file contents...');

                        if (file.name.endsWith('.csv')) {
                            const text = await file.text();
                            this.updateProgress(50, 'Parsing CSV data...');
                            Papa.parse(text, {
                                header: true,
                                skipEmptyLines: true,
                                complete: (result) => {
                                    this.rawData = result.data;
                                    this.setupColumnMapping(result.meta.fields);
                                    this.hideLoading();
                                }
                            });
                        } else if (file.name.endsWith('.xlsx')) {
                            const arrayBuffer = await file.arrayBuffer();
                            this.updateProgress(50, 'Parsing Excel data...');
                            const workbook = XLSX.read(arrayBuffer, { type: 'array' });
                            const sheetName = workbook.SheetNames[0];
                            this.rawData = XLSX.utils.sheet_to_json(workbook.Sheets[sheetName]);
                            if (this.rawData.length > 0) this.setupColumnMapping(Object.keys(this.rawData[0]));
                            this.hideLoading();
                        }
                    } catch (error) {
                        console.error('Error processing file:', error);
                        alert('Error processing file. Please check the format and try again.');
                        this.hideLoading();
                    }
                    event.target.value = '';
                }

                setupColumnMapping(columns) {
                    const mappingSection = document.getElementById('columnMapping');
                    mappingSection.style.display = 'block';

                    const selects = {
                        campaignColumnSelect: /campaign/i,
                        keywordColumnSelect: /keyword|search term/i,
                        asinColumnSelect: /asin/i,
                        salesColumnSelect: /sales/i,
                        ordersColumnSelect: /orders/i,
                        conversionColumnSelect: /conversion|cvr/i,
                        acosColumnSelect: /acos/i,
                        matchColumnSelect: /match/i, // NEW: Match Type column
                        campaignStatusColumnSelect: /campaign status/i,
                        keywordStatusColumnSelect: /keyword status|status/i,
                    };

                    Object.keys(selects).forEach(selectId => {
                        const select = document.getElementById(selectId);
                        select.innerHTML = '<option value="">Select Column</option>';
                        columns.forEach(col => {
                            select.innerHTML += `<option value="${col}">${col}</option>`;
                        });
                        const pattern = selects[selectId];
                        const matchingColumn = columns.find(col => pattern.test(col));
                        if (matchingColumn) {
                            select.value = matchingColumn;
                        }
                    });
                }

                async applyColumnMapping() {
                    const requiredCols = ['campaignColumnSelect', 'keywordColumnSelect', 'salesColumnSelect', 'acosColumnSelect', 'asinColumnSelect', 'ordersColumnSelect'];
                    for (const colId of requiredCols) {
                        if (!document.getElementById(colId).value) {
                            alert(`Please map all required columns. '${colId.replace("ColumnSelect", "")}' is missing.`);
                            return;
                        }
                    }

                    this.showLoading('Processing Data', 'Mapping columns and processing keywords...');
                    const colMap = {
                        campaign: document.getElementById('campaignColumnSelect').value,
                        name: document.getElementById('keywordColumnSelect').value,
                        asin: document.getElementById('asinColumnSelect').value,
                        sales: document.getElementById('salesColumnSelect').value,
                        orders: document.getElementById('ordersColumnSelect').value,
                        conversion: document.getElementById('conversionColumnSelect').value,
                        acos: document.getElementById('acosColumnSelect').value,
                        match: document.getElementById('matchColumnSelect').value, // NEW: Match Type
                        campaignStatus: document.getElementById('campaignStatusColumnSelect').value,
                        keywordStatus: document.getElementById('keywordStatusColumnSelect').value,
                    };

                    // Track uploaded rows for debug
                    this.totalUploadedRows = this.rawData.length;
                    this.filteredRowsCount = 0;

                    const newKeywords = this.rawData.map((row, index) => {
                        const clean = (val) => String(val || '').toLowerCase().trim();
                        const salesRawValue = row[colMap.sales];
                        const salesIsEmpty = salesRawValue === undefined || salesRawValue === null || String(salesRawValue).trim() === '';

                        const keyword = {
                            id: Date.now() + index,
                            rowNumber: index + 2, // +2 because CSV is 1-indexed and has header row
                            campaign: row[colMap.campaign] || 'N/A',
                            name: row[colMap.name] || 'N/A',
                            asin: row[colMap.asin] || 'N/A',
                            matchType: colMap.match && row[colMap.match] ? String(row[colMap.match]).trim().toLowerCase() : undefined,
                            sales: parseFloat(String(row[colMap.sales]).replace(/[^0-9.-]+/g, "")) || 0,
                            salesWasEmpty: salesIsEmpty,
                            orders: parseInt(row[colMap.orders]) || 0,
                            conversion: parseFloat(String(row[colMap.conversion]).replace(/[^0-9.-]+/g, "")) || 0,
                            acos: parseFloat(String(row[colMap.acos]).replace(/[^0-9.-]+/g, "")) || 0,
                            campaignStatus: clean(row[colMap.campaignStatus]) || 'enabled',
                            keywordStatus: clean(row[colMap.keywordStatus]) || 'enabled'
                        };

                        // Debug: Log filtered rows
                        if (this.debugMode) {
                            if (keyword.name === 'N/A') {
                                this.filteredRowsCount++;
                                this.debugLog.push({
                                    rowNumber: index + 2,
                                    keyword: '(empty)',
                                    asin: keyword.asin !== 'N/A' ? keyword.asin : '(empty)',
                                    matchType: keyword.matchType || 'Unknown',
                                    decision: 'FILTERED',
                                    reason: 'Missing Keyword - Row excluded from processing'
                                });
                            } else if (keyword.asin === 'N/A') {
                                this.filteredRowsCount++;
                                this.debugLog.push({
                                    rowNumber: index + 2,
                                    keyword: keyword.name,
                                    asin: '(empty)',
                                    matchType: keyword.matchType || 'Unknown',
                                    decision: 'FILTERED',
                                    reason: 'Missing ASIN - Row excluded from processing'
                                });
                            } else if (keyword.campaignStatus === 'paused') {
                                this.filteredRowsCount++;
                                this.debugLog.push({
                                    rowNumber: index + 2,
                                    keyword: keyword.name,
                                    asin: keyword.asin,
                                    matchType: keyword.matchType || 'Unknown',
                                    decision: 'FILTERED',
                                    reason: 'Campaign Paused - Row excluded from processing'
                                });
                            } else if (keyword.keywordStatus === 'paused') {
                                this.filteredRowsCount++;
                                this.debugLog.push({
                                    rowNumber: index + 2,
                                    keyword: keyword.name,
                                    asin: keyword.asin,
                                    matchType: keyword.matchType || 'Unknown',
                                    decision: 'FILTERED',
                                    reason: 'Keyword Paused - Row excluded from processing'
                                });
                            }
                        }

                        return keyword;
                    }).filter(k =>
                        k.name !== 'N/A' &&
                        k.asin !== 'N/A' &&
                        k.campaignStatus !== 'paused' &&
                        k.keywordStatus !== 'paused'
                    );

                    this.keywords = newKeywords;
                    this.populateAsinFilter();
                    document.getElementById('columnMapping').style.display = 'none';

                    setTimeout(() => {
                        this.hideLoading();
                        this.calculateScores();
                    }, 500);
                }

                populateAsinFilter() {
                    this.uniqueAsins = new Set(this.keywords.map(k => k.asin));
                    const asinFilter = document.getElementById('asinFilter');
                    asinFilter.innerHTML = '<option value="">All ASINs</option>';
                    this.uniqueAsins.forEach(asin => {
                        asinFilter.innerHTML += `<option value="${asin}">${asin}</option>`;
                    });
                }

                updateWeight(fieldId, value) {
                    this.weights[fieldId.replace('Weight', '')] = parseInt(value) || 0;
                    this.calculateScores();
                }

                async calculateScores() {
                    if (this.keywords.length === 0) return;

                    const salesValues = this.keywords.map(k => k.sales);
                    const conversionValues = this.keywords.map(k => k.conversion);
                    const acosValues = this.keywords.map(k => k.acos);
                    const minSales = Math.min(...salesValues), maxSales = Math.max(...salesValues);
                    const minConversion = Math.min(...conversionValues), maxConversion = Math.max(...conversionValues);
                    const minAcos = Math.min(...acosValues), maxAcos = Math.max(...acosValues);

                    // Debug: Log normalization ranges
                    if (this.debugMode) {
                        this.debugLog.push({
                            rowNumber: '',
                            keyword: '📊 SCORING SETUP',
                            asin: '',
                            matchType: '',
                            decision: 'INFO',
                            reason: `<b>📖 HOW SCORING WORKS</b><br><br><b>Example:</b> Imagine 2 duplicate keywords:<br>• Keyword A: Sales $150, Conversion 12%, ACOS 25%<br>• Keyword B: Sales $80, Conversion 8%, ACOS 40%<br><br><b>Step 1: Score Each Metric (0-100)</b><br>Each metric is scored where best = 100, worst = 0.<br>For ACOS, LOWER is better, so it's inverted.<br><br><b>Step 2: Apply Your Weights</b><br>ACOS: ${this.weights.acos}% | Conversion: ${this.weights.conversion}% | Sales: ${this.weights.sales}%<br><br><b>Step 3: Calculate Final Score</b><br>Final Score = (ACOS score × ${this.weights.acos / 100}) + (Conv score × ${this.weights.conversion / 100}) + (Sales score × ${this.weights.sales / 100})<br><br><b>Result:</b> Higher score = KEEP ✅ | Lower score = PAUSE ❌<br><br><b>Your Data Ranges:</b><br>Sales: $${minSales.toFixed(2)} - $${maxSales.toFixed(2)}<br>Conversion: ${minConversion.toFixed(1)}% - ${maxConversion.toFixed(1)}%<br>ACOS: ${minAcos.toFixed(1)}% - ${maxAcos.toFixed(1)}%`
                        });
                    }

                    this.results = this.keywords.map(keyword => {
                        const salesScore = maxSales === minSales ? 100 : ((keyword.sales - minSales) / (maxSales - minSales)) * 100;
                        const conversionScore = maxConversion === minConversion ? 100 : ((keyword.conversion - minConversion) / (maxConversion - minConversion)) * 100;
                        const acosScore = maxAcos === minAcos ? 100 : ((maxAcos - keyword.acos) / (maxAcos - minAcos)) * 100;
                        const compositeScore = (acosScore * this.weights.acos / 100) + (conversionScore * this.weights.conversion / 100) + (salesScore * this.weights.sales / 100);
                        return { ...keyword, compositeScore: compositeScore.toFixed(1) };
                    });

                    this.identifyDuplicates();
                    this.updateSummary();
                }

                identifyDuplicates() {
                    const keywordGroups = {};
                    this.zeroSalesKeywords = []; // Store zero sales keywords separately

                    this.results.forEach(keyword => {
                        // Exclude zero sales keywords from duplicate comparison
                        if (keyword.sales === 0 || keyword.sales === '0') {
                            this.zeroSalesKeywords.push(keyword);
                            if (this.debugMode) {
                                // Distinguish between empty field and actual $0.00 sales
                                const reason = keyword.salesWasEmpty
                                    ? 'No Sales Data (Empty sales field in CSV) - Excluded from duplicate grouping'
                                    : 'Zero Sales ($0.00) - Excluded from duplicate grouping';

                                this.debugLog.push({
                                    rowNumber: keyword.rowNumber || '',
                                    keyword: keyword.name,
                                    asin: keyword.asin,
                                    matchType: keyword.matchType || 'Unknown',
                                    decision: 'Skipped',
                                    reason: reason
                                });
                            }
                            return; // Skip this keyword in duplicate grouping
                        }

                        // Parse campaign name to extract product+variation and campaign type
                        const parsed = this.parseCampaignName(keyword.campaign);

                        // ASIN Detection: Check if keyword itself is an ASIN (starts with B0)
                        const isAsinKeyword = /^B0[A-Z0-9]{8}$/i.test(keyword.name.trim());

                        // Use matchType from keyword data if available (from bulk file), 
                        // otherwise check if it's an ASIN keyword,
                        // otherwise use parsed from campaign name
                        let finalMatchType;
                        let matchSource;

                        if (keyword.matchType) {
                            finalMatchType = keyword.matchType;
                            matchSource = 'CSV column';
                        } else if (isAsinKeyword) {
                            finalMatchType = 'ASIN Targeting';
                            matchSource = 'Keyword pattern (B0*)';
                        } else {
                            finalMatchType = parsed.matchType;
                            matchSource = parsed.matchType !== 'Unknown' ? 'Campaign name' : 'Unknown';
                        }

                        // Debug: Log campaign parsing details
                        if (this.debugMode) {
                            this.debugLog.push({
                                rowNumber: keyword.rowNumber || '',
                                keyword: keyword.name,
                                asin: keyword.asin,
                                matchType: finalMatchType,
                                decision: 'PARSED',
                                reason: `Campaign: "${keyword.campaign}" → Product: "${parsed.productVariation}" | Type: ${parsed.campaignType} | Match: ${finalMatchType} (from ${matchSource})`
                            });
                        }

                        // Grouping key: keyword + asin + product+variation + campaign type + match type
                        const key = `${keyword.name.toLowerCase().trim()}|${keyword.asin.toLowerCase().trim()}|${parsed.productVariation}|${parsed.campaignType}|${finalMatchType}`;
                        if (!keywordGroups[key]) keywordGroups[key] = [];
                        keywordGroups[key].push(keyword);
                    });
                    this.duplicates = Object.fromEntries(Object.entries(keywordGroups).filter(([_, v]) => v.length > 1));

                    // Clear and rebuild selected keywords map with new duplicates (all checked by default)
                    this.selectedKeywordsToPause.clear();
                    Object.values(this.duplicates).forEach(list => {
                        const sorted = [...list].sort((a, b) => parseFloat(b.compositeScore) - parseFloat(a.compositeScore));

                        // Assign recommendation property for Chapter 5 rendering
                        sorted[0].recommendation = 'keep';  // Winner
                        sorted.slice(1).forEach(k => k.recommendation = 'remove');  // Losers

                        const winner = sorted[0];
                        const losers = sorted.slice(1);

                        // Debug logging for each duplicate group
                        if (this.debugMode) {
                            // Log the winner
                            this.debugLog.push({
                                keyword: winner.name,
                                asin: winner.asin,
                                matchType: winner.matchType || 'Unknown',
                                decision: 'KEEP',
                                reason: `Winner of ${sorted.length} duplicates (Score: ${winner.compositeScore}, Sales: $${winner.sales.toFixed(2)}, ACOS: ${winner.acos.toFixed(1)}%)`
                            });

                            // Log the losers
                            losers.forEach((kw, idx) => {
                                this.debugLog.push({
                                    keyword: kw.name,
                                    asin: kw.asin,
                                    matchType: kw.matchType || 'Unknown',
                                    decision: 'PAUSE',
                                    reason: `Duplicate #${idx + 2} of ${sorted.length} (Score: ${kw.compositeScore}, Sales: $${kw.sales.toFixed(2)}, ACOS: ${kw.acos.toFixed(1)}%) - Lower performance`
                                });
                            });
                        }

                        // Select losers for pausing
                        losers.forEach(kw => this.selectedKeywordsToPause.set(kw.id, true));
                    });

                    // Update debug stats if enabled
                    if (this.debugMode) {
                        document.getElementById('debugTotalUploaded').textContent = this.totalUploadedRows;
                        document.getElementById('debugFiltered').textContent = this.filteredRowsCount;
                        document.getElementById('debugTotalProcessed').textContent = this.results.length - this.zeroSalesKeywords.length;
                        document.getElementById('debugDuplicateGroups').textContent = Object.keys(this.duplicates).length;
                        document.getElementById('debugMarkedForRemoval').textContent = this.selectedKeywordsToPause.size;
                        document.getElementById('debugZeroSales').textContent = this.zeroSalesKeywords.length;
                        this.renderDebugChapters();
                    }

                    this.renderRecommendations();
                    this.updateSelectedCount();
                }

                getCampaignType(campaignName) {
                    const name = campaignName.toLowerCase();
                    if (name.includes('sp') && name.includes('auto')) return 'SP Auto';
                    if (name.includes('sp') && (name.includes('manual') || name.includes('keyword') || name.includes('product'))) return 'SP Manual';
                    if (name.includes('sb') && name.includes('video')) return 'SB Video';
                    if (name.includes('sd') && name.includes('display')) return 'SD Display';
                    return 'Other';
                }

                renderRecommendations() {
                    const section = document.getElementById('recommendationsSection');
                    const list = document.getElementById('recommendationsList');
                    const paginationControls = document.getElementById('duplicatesPagination');

                    // Also render zero sales keywords
                    this.renderZeroSalesKeywords();

                    if (Object.keys(this.duplicates).length === 0) {
                        // Hide the duplicate list but keep section if there are zero sales keywords
                        if (this.zeroSalesKeywords && this.zeroSalesKeywords.length > 0) {
                            section.style.display = 'block';
                            list.innerHTML = '<p class="text-small" style="color: #78350f; text-align: center; padding: 20px;">No duplicate keywords found (excluding zero sales keywords shown below).</p>';
                            paginationControls.style.display = 'none';
                        } else {
                            section.style.display = 'none';
                        }
                        return;
                    }
                    section.style.display = 'block';

                    // 1. Get filter values
                    const searchFilter = document.getElementById('duplicateSearchFilter').value.toLowerCase();
                    const asinFilter = document.getElementById('asinFilter').value;
                    const minCampaigns = parseInt(document.getElementById('minCampaignsFilter').value);
                    const sortFilter = document.getElementById('duplicateSortFilter').value;
                    const statusFilter = document.getElementById('statusFilter').value;
                    const campaignTypeFilter = document.getElementById('campaignTypeFilter').value;
                    const excludeSingleOrder = document.getElementById('excludeSingleOrderFilter').checked;

                    // 2. Process and filter duplicates
                    let processedDuplicates = Object.values(this.duplicates).map(keywordList => {
                        const sortedByScore = [...keywordList].sort((a, b) => parseFloat(b.compositeScore) - parseFloat(a.compositeScore));
                        return { list: sortedByScore, asin: sortedByScore[0].asin };
                    });

                    // Apply filters
                    if (asinFilter) processedDuplicates = processedDuplicates.filter(item => item.asin === asinFilter);
                    if (statusFilter === 'enabled') processedDuplicates = processedDuplicates.filter(group => group.list.some(kw => kw.keywordStatus === 'enabled'));
                    if (statusFilter === 'campaign_enabled') processedDuplicates = processedDuplicates.filter(group => group.list.some(kw => kw.campaignStatus === 'enabled'));
                    if (campaignTypeFilter) processedDuplicates = processedDuplicates.filter(group => group.list.some(kw => this.getCampaignType(kw.campaign) === campaignTypeFilter));
                    if (excludeSingleOrder) processedDuplicates = processedDuplicates.filter(group => !group.list.every(kw => kw.orders <= 1));

                    this.filteredDuplicates = processedDuplicates.map(group => {
                        const best = group.list[0];
                        const rest = group.list.slice(1);
                        const savings = rest.reduce((sum, kw) => sum + (kw.sales * (kw.acos / 100)), 0);
                        return { best, rest, savings, count: group.list.length };
                    }).filter(item =>
                        item.count >= minCampaigns &&
                        item.best.name.toLowerCase().includes(searchFilter)
                    );

                    // 3. Apply sorting
                    if (sortFilter === 'savings-desc') this.filteredDuplicates.sort((a, b) => b.savings - a.savings);
                    else if (sortFilter === 'campaigns-desc') this.filteredDuplicates.sort((a, b) => b.count - a.count);
                    else if (sortFilter === 'keyword-asc') this.filteredDuplicates.sort((a, b) => a.best.name.localeCompare(b.best.name));

                    // 4. Update stats and pagination
                    const totalWastedSpend = this.filteredDuplicates.reduce((sum, item) => sum + item.savings, 0);
                    const keywordsToPause = this.filteredDuplicates.reduce((sum, item) => sum + item.rest.length, 0);
                    document.getElementById('totalDuplicatesFound').textContent = this.filteredDuplicates.length;
                    document.getElementById('totalWastedSpend').textContent = `$${totalWastedSpend.toFixed(0)}`;
                    document.getElementById('campaignsToOptimize').textContent = keywordsToPause;

                    // Pagination logic
                    const totalItems = this.filteredDuplicates.length;
                    paginationControls.style.display = totalItems > 0 ? 'flex' : 'none';
                    if (totalItems === 0) { list.innerHTML = '<p style="text-align: center; padding: 24px; color: #6b7280;">No duplicates match filters.</p>'; return; }
                    const totalPages = Math.ceil(totalItems / this.duplicatesRowsPerPage);
                    this.duplicatesCurrentPage = Math.min(this.duplicatesCurrentPage, totalPages) || 1;
                    const startIndex = (this.duplicatesCurrentPage - 1) * this.duplicatesRowsPerPage;
                    const endIndex = Math.min(startIndex + this.duplicatesRowsPerPage, totalItems);
                    const pageData = this.filteredDuplicates.slice(startIndex, endIndex);

                    document.getElementById('duplicatesShowingStart').textContent = totalItems > 0 ? startIndex + 1 : 0;
                    document.getElementById('duplicatesShowingEnd').textContent = endIndex;
                    document.getElementById('duplicatesTotalFiltered').textContent = totalItems;
                    document.getElementById('duplicatesPrevPageBtn').disabled = this.duplicatesCurrentPage <= 1;
                    document.getElementById('duplicatesNextPageBtn').disabled = this.duplicatesCurrentPage >= totalPages;

                    // 5. Render UI
                    list.innerHTML = '';
                    pageData.forEach((rec, index) => {
                        const absoluteIndex = startIndex + index;
                        const item = document.createElement('div');
                        item.className = 'collapsible-section';
                        const { best, rest, savings, count } = rec;

                        item.innerHTML = `
                        <div class="collapsible-header" onclick="calculator.toggleCollapsible(${absoluteIndex})">
                            <div><strong>${best.name}</strong> (${best.asin}) - ${count} campaigns - <span style="color: #15803d; cursor: help;" title="Savings = Sales × (ACOS/100) = Ad spend saved by pausing">$${savings.toFixed(2)} savings ℹ️</span></div>
                            <div class="dropdown-arrow" id="arrow-${absoluteIndex}">▼</div>
                        </div>
                        <div class="collapsible-content" id="content-${absoluteIndex}">
                            <div class="recommendation-grid">
                                <div class="keep-section">
                                    <p class="text-small font-bold" style="color: #15803d; margin-bottom: 4px;">✅ KEEP THIS KEYWORD:</p>
                                    <p class="font-bold" style="color: #166534;">${best.campaign}</p>
                                    <p class="text-small" style="color: #16a34a;">Performance Score: ${best.compositeScore}</p>
                                    <p class="metrics-details">Sales: $${best.sales.toFixed(2)} | Conv: ${best.conversion.toFixed(2)}% | ACOS: ${best.acos.toFixed(2)}%</p>
                                    ${this.formatExtraMetrics(best)}
                                </div>
                                <div class="remove-section">
                                    <p class="text-small font-bold" style="color: #dc2626; margin-bottom: 4px;">❌ PAUSE THESE KEYWORDS:</p>
                                    ${rest.length > 0 ? rest.map(kw => `
                                        <div style="margin-top: 8px; display: flex; align-items: flex-start; gap: 8px;">
                                            <input type="checkbox" 
                                                id="pause-kw-${kw.id}" 
                                                ${this.selectedKeywordsToPause.has(kw.id) ? 'checked' : ''} 
                                                onchange="calculator.toggleKeywordSelection(${kw.id}, this.checked)"
                                                style="margin-top: 4px; cursor: pointer;">
                                            <div style="flex: 1;">
                                                <label for="pause-kw-${kw.id}" class="font-bold" style="color: #b91c1c; cursor: pointer;">${kw.campaign}</label>
                                                <span class="text-small" style="color: #dc2626; margin-left: 8px;">(Score: ${kw.compositeScore})</span>
                                                <p class="metrics-details">Sales: $${kw.sales.toFixed(2)} | Conv: ${kw.conversion.toFixed(2)}% | ACOS: ${kw.acos.toFixed(2)}%</p>
                                                ${calculator.formatExtraMetrics(kw)}
                                            </div>
                                        </div>`).join('') : '<p class="text-small">None</p>'}
                                </div>
                            </div>
                        </div>`;
                        list.appendChild(item);
                    });
                }

                toggleCollapsible(index) {
                    const content = document.getElementById(`content-${index}`);
                    const arrow = document.getElementById(`arrow-${index}`);
                    content.classList.toggle('expanded');
                    arrow.classList.toggle('rotated');
                }

                // Format extra metrics from allMetrics object for display
                formatExtraMetrics(keyword) {
                    if (!keyword.allMetrics || Object.keys(keyword.allMetrics).length === 0) {
                        // Fallback: show impressions, clicks, spend if available
                        const extras = [];
                        if (keyword.impressions !== undefined && keyword.impressions > 0) {
                            extras.push(`Impressions: ${keyword.impressions.toLocaleString()}`);
                        }
                        if (keyword.clicks !== undefined && keyword.clicks > 0) {
                            extras.push(`Clicks: ${keyword.clicks.toLocaleString()}`);
                        }
                        if (keyword.spend !== undefined && keyword.spend > 0) {
                            extras.push(`Spend: $${keyword.spend.toFixed(2)}`);
                        }
                        if (keyword.orders !== undefined && keyword.orders > 0) {
                            extras.push(`Orders: ${keyword.orders}`);
                        }
                        if (extras.length === 0) return '';
                        return `<p class="metrics-details" style="margin-top: 4px; color: #6b7280;">${extras.join(' | ')}</p>`;
                    }

                    // Display all metrics from allMetrics object
                    const skipKeys = ['Sales', 'Spend', 'ACOS', 'Conversion', '7 Day Total Sales', 'Cost'];
                    const extras = [];

                    Object.entries(keyword.allMetrics).forEach(([key, value]) => {
                        // Skip main metrics already shown
                        const keyLower = key.toLowerCase();
                        if (skipKeys.some(sk => keyLower.includes(sk.toLowerCase()))) return;

                        // Format the value
                        let formattedValue;
                        if (keyLower.includes('rate') || keyLower.includes('ctr')) {
                            formattedValue = `${(value * 100).toFixed(2)}%`;
                        } else if (keyLower.includes('cpc') || keyLower.includes('cost')) {
                            formattedValue = `$${value.toFixed(2)}`;
                        } else if (Number.isInteger(value)) {
                            formattedValue = value.toLocaleString();
                        } else {
                            formattedValue = value.toFixed(2);
                        }

                        // Clean up key name for display
                        const displayKey = key.replace(/\(Informational only\)/gi, '').trim();
                        extras.push(`${displayKey}: ${formattedValue}`);
                    });

                    if (extras.length === 0) return '';
                    return `<p class="metrics-details" style="margin-top: 4px; color: #6b7280;">${extras.join(' | ')}</p>`;
                }


                toggleZeroSalesSection() {
                    const content = document.getElementById('content-zero-sales');
                    const arrow = document.getElementById('arrow-zero-sales');
                    content.classList.toggle('expanded');
                    arrow.classList.toggle('rotated');
                }

                renderZeroSalesKeywords() {
                    const section = document.getElementById('zeroSalesSection');
                    const list = document.getElementById('zeroSalesKeywordsList');
                    const countSpan = document.getElementById('zeroSalesCount');

                    if (!this.zeroSalesKeywords || this.zeroSalesKeywords.length === 0) {
                        section.style.display = 'none';
                        return;
                    }

                    section.style.display = 'block';
                    countSpan.textContent = `(${this.zeroSalesKeywords.length} keywords)`;

                    list.innerHTML = this.zeroSalesKeywords.map(kw => `
                        <div style="padding: 8px 12px; background: #fefce8; border-radius: 6px; margin-bottom: 8px; border: 1px solid #fde047;">
                            <div style="display: flex; justify-content: space-between; align-items: center;">
                                <div>
                                    <span class="font-bold" style="color: #854d0e;">${kw.name}</span>
                                    <span class="text-small" style="color: #a16207; margin-left: 8px;">(${kw.asin})</span>
                                </div>
                                <span class="text-small" style="color: #92400e;">Score: ${kw.compositeScore}</span>
                            </div>
                            <p class="text-small" style="color: #78350f; margin-top: 4px;">${kw.campaign}</p>
                            <p class="metrics-details" style="margin-top: 4px;">Sales: $0.00 | Conv: ${kw.conversion.toFixed(2)}% | ACOS: ${kw.acos.toFixed(2)}%</p>
                        </div>
                    `).join('');
                }

                updateSummary() {
                    const totalKeywords = this.results.length;
                    const duplicateCount = Object.keys(this.duplicates).length;
                    const removeCount = this.results.filter(r => parseFloat(r.compositeScore) < 40).length;
                    const totalSavings = Object.values(this.duplicates).reduce((sum, list) => {
                        const sorted = list.sort((a, b) => b.compositeScore - a.compositeScore);
                        const rest = sorted.slice(1);
                        return sum + rest.reduce((subSum, kw) => subSum + (kw.sales * (kw.acos / 100)), 0);
                    }, 0);
                    document.getElementById('totalKeywords').textContent = totalKeywords;
                    document.getElementById('duplicateCount').textContent = duplicateCount;
                    document.getElementById('removeCount').textContent = removeCount;
                    document.getElementById('potentialSavings').textContent = `$${totalSavings.toFixed(0)}`;
                }

                // Generate pause bulk file for download
                generatePauseBulkFile() {
                    if (!this.bulkFileData || Object.keys(this.bulkFileWorksheets).length === 0) {
                        alert('Please upload a bulk file first.');
                        return;
                    }

                    if (this.selectedKeywordsToPause.size === 0) {
                        alert('No keywords selected to pause. Please select at least one keyword.');
                        return;
                    }

                    this.showLoading('Generating Bulk File', 'Creating pause bulk file...');

                    try {
                        // Get all keywords that should be paused (by campaign name + keyword text)
                        const keywordsToPause = new Set();
                        this.results.forEach(kw => {
                            if (this.selectedKeywordsToPause.has(kw.id)) {
                                // Store campaign name + keyword/asin for matching
                                keywordsToPause.add(`${kw.campaign.toLowerCase().trim()}|${kw.name.toLowerCase().trim()}`);
                            }
                        });

                        // Create new workbook for output
                        const outputWorkbook = XLSX.utils.book_new();
                        let totalRowsPaused = 0;

                        // Track which keywords we've already processed (for SB deduplication)
                        const processedKeywords = new Set();

                        // Sort worksheets to prioritize main sheets over multi ad group
                        const sortedSheets = Object.entries(this.bulkFileWorksheets).sort(([nameA], [nameB]) => {
                            // Priority order: Sponsored Products first, then main SB, then Multi Ad Group last
                            const getPriority = (name) => {
                                const lower = name.toLowerCase();
                                if (lower.includes('sponsored products')) return 1;
                                if (lower.includes('sponsored brands') && !lower.includes('multi')) return 2;
                                if (lower.includes('multi ad group')) return 4;
                                return 3;
                            };
                            return getPriority(nameA) - getPriority(nameB);
                        });

                        // Process each worksheet
                        sortedSheets.forEach(([sheetName, sheetInfo]) => {
                            const { allData, headers } = sheetInfo;

                            // Smart column detection
                            const columnMap = this.findColumnsSmartly(headers);

                            // Filter rows: only Keyword/Product Targeting entities that match selected keywords
                            const filteredRows = allData.filter(row => {
                                const entity = String(row['Entity'] || '').toLowerCase();
                                if (entity !== 'keyword' && entity !== 'product targeting') return false;

                                // Get campaign name (prefer informational column)
                                const campaignName = String(
                                    this.getColumnValue(row, columnMap.campaignNameInfo) ||
                                    this.getColumnValue(row, columnMap.campaignName) || ''
                                ).toLowerCase().trim();

                                let keywordText = '';

                                if (entity === 'keyword') {
                                    keywordText = String(this.getColumnValue(row, columnMap.keywordText) || '').toLowerCase().trim();
                                } else if (entity === 'product targeting') {
                                    keywordText = String(this.getColumnValue(row, columnMap.productTargeting) || '').toLowerCase().trim();
                                }

                                const matchKey = `${campaignName}|${keywordText}`;

                                // Check if already processed (for SB deduplication)
                                if (processedKeywords.has(matchKey)) {
                                    return false;
                                }

                                if (keywordsToPause.has(matchKey)) {
                                    processedKeywords.add(matchKey);
                                    return true;
                                }
                                return false;
                            });

                            if (filteredRows.length > 0) {
                                // Update State to 'paused' and add Operation='update' for all matched rows
                                const updatedRows = filteredRows.map(row => {
                                    const newRow = { ...row };

                                    // Add 'update' to Operation column
                                    if ('Operation' in newRow) newRow['Operation'] = 'update';
                                    else if ('operation' in newRow) newRow['operation'] = 'update';
                                    else newRow['Operation'] = 'update'; // Add if doesn't exist

                                    // Find the State column (could be various names)
                                    if ('State' in newRow) newRow['State'] = 'paused';
                                    else if ('state' in newRow) newRow['state'] = 'paused';
                                    return newRow;
                                });

                                totalRowsPaused += updatedRows.length;

                                // Create worksheet with all original columns
                                const ws = XLSX.utils.json_to_sheet(updatedRows, { header: headers });

                                // Determine output sheet name (combine SB sheets into one)
                                let outputSheetName = sheetName;
                                if (sheetName.toLowerCase().includes('multi ad group')) {
                                    outputSheetName = 'Sponsored Brands Campaigns';
                                }

                                // If sheet already exists, append to it
                                if (outputWorkbook.SheetNames.includes(outputSheetName)) {
                                    // Append rows to existing sheet
                                    const existingWs = outputWorkbook.Sheets[outputSheetName];
                                    const existingData = XLSX.utils.sheet_to_json(existingWs);
                                    const combinedData = [...existingData, ...updatedRows];
                                    const combinedWs = XLSX.utils.json_to_sheet(combinedData, { header: headers });
                                    outputWorkbook.Sheets[outputSheetName] = combinedWs;
                                } else {
                                    XLSX.utils.book_append_sheet(outputWorkbook, ws, outputSheetName);
                                }
                            }
                        });

                        if (totalRowsPaused === 0) {
                            this.hideLoading();
                            alert('No matching keywords found in the bulk file. Please ensure the campaign names and keywords match between the files.');
                            return;
                        }

                        // Generate and download file
                        const timestamp = new Date().toISOString().slice(0, 10).replace(/-/g, '');
                        const fileName = `pause_keywords_bulk_${timestamp}.xlsx`;
                        XLSX.writeFile(outputWorkbook, fileName);

                        this.hideLoading();
                        alert(`Success! Generated bulk file with ${totalRowsPaused} keywords to pause.\nFile: ${fileName}`);

                    } catch (error) {
                        console.error('Error generating bulk file:', error);
                        this.hideLoading();
                        alert('Error generating bulk file. Please try again.');
                    }
                }

                // Debug Mode Helper Functions
                renderDebugLog() {
                    const tbody = document.getElementById('debugLogTableBody');
                    if (!this.debugLog || this.debugLog.length === 0) {
                        tbody.innerHTML = '<tr><td colspan="6" style="text-align: center; padding: 20px; color: #9ca3af;">No debug data available</td></tr>';
                        return;
                    }

                    const searchTerm = (document.getElementById('debugLogSearch')?.value || '').toLowerCase();
                    const filteredLog = searchTerm
                        ? this.debugLog.filter(entry =>
                            entry.keyword.toLowerCase().includes(searchTerm) ||
                            entry.asin.toLowerCase().includes(searchTerm) ||
                            entry.reason.toLowerCase().includes(searchTerm)
                        )
                        : this.debugLog;

                    if (filteredLog.length === 0) {
                        tbody.innerHTML = '<tr><td colspan="6" style="text-align: center; padding: 20px; color: #9ca3af;">No matches found</td></tr>';
                        return;
                    }

                    tbody.innerHTML = filteredLog.map(entry => {
                        const decisionColors = {
                            'KEEP': { bg: '#f0fdf4', text: '#15803d' },
                            'PAUSE': { bg: '#fef2f2', text: '#dc2626' },
                            'Skipped': { bg: '#fef3c7', text: '#f59e0b' },
                            'FILTERED': { bg: '#fef3c7', text: '#ea580c' },
                            'INFO': { bg: '#eff6ff', text: '#1d4ed8' },
                            'PARSED': { bg: '#f5f3ff', text: '#6d28d9' }
                        };
                        const colors = decisionColors[entry.decision] || { bg: '#f3f4f6', text: '#4b5563' };
                        const rowNum = entry.rowNumber || '';

                        return `
                            <tr style="border-bottom: 1px solid #e5e7eb;">
                                <td style="padding: 12px 8px; color: #9ca3af; font-size: 12px;">${rowNum}</td>
                                <td style="padding: 12px 8px; font-weight: 500;">${entry.keyword}</td>
                                <td style="padding: 12px 8px; color: #6b7280;">${entry.asin}</td>
                                <td style="padding: 12px 8px; color: #6b7280;">${entry.matchType}</td>
                                <td style="padding: 12px 8px;">
                                    <span style="background: ${colors.bg}; color: ${colors.text}; padding: 4px 8px; border-radius: 4px; font-size: 12px; font-weight: 600;">${entry.decision}</span>
                                </td>
                                <td style="padding: 12px 8px; color: #374151; font-size: 13px;">${entry.reason}</td>
                            </tr>
                        `;
                    }).join('');
                }

                filterDebugLog() {
                    this.renderDebugLog();
                }

                // New Chapter-Based Debug Rendering
                toggleChapter(chapterId) {
                    const content = document.getElementById(`chapter${chapterId.charAt(0).toUpperCase() + chapterId.slice(1)}`);
                    const toggle = document.getElementById(`${chapterId}Toggle`);

                    if (content.style.display === 'none') {
                        content.style.display = 'block';
                        toggle.textContent = '▲';
                    } else {
                        content.style.display = 'none';
                        toggle.textContent = '▼';
                    }
                }

                renderDebugChapters() {
                    if (!this.debugLog || this.debugLog.length === 0) return;

                    // Organize debug log into chapters
                    const filtered = this.debugLog.filter(e => e.decision === 'FILTERED');
                    const skipped = this.debugLog.filter(e => e.decision === 'Skipped');
                    const parsed = this.debugLog.filter(e => e.decision === 'PARSED');
                    const info = this.debugLog.filter(e => e.decision === 'INFO');
                    const decisions = this.debugLog.filter(e => e.decision === 'KEEP' || e.decision === 'PAUSE');

                    // Update chapter counts
                    document.getElementById('filteredCount').textContent = `(${filtered.length} rows)`;
                    document.getElementById('skippedCount').textContent = `(${skipped.length} rows)`;
                    document.getElementById('analysisCount').textContent = `(${this.results ? this.results.length - this.zeroSalesKeywords.length : 0} keywords)`;
                    document.getElementById('decisionsCount').textContent = `(${this.duplicates ? Object.keys(this.duplicates).length : 0} groups)`;
                    document.getElementById('debugUniqueCount').textContent = this.results ? this.results.length - decisions.filter(d => d.decision === 'PAUSE').length : 0;

                    // Render Chapter 2: Filtered Rows
                    if (filtered.length > 0) {
                        document.getElementById('filteredTable').innerHTML = `
                            <table style="width: 100%; font-size: 13px; border-collapse: collapse;">
                                <thead>
                                    <tr style="background: #fef3c7; text-align: left;">
                                        <th style="padding: 8px; width: 60px;">Row #</th>
                                        <th style="padding: 8px;">Keyword</th>
                                        <th style="padding: 8px;">ASIN</th>
                                        <th style="padding: 8px; width: 150px;">Why?</th>
                                    </tr>
                                </thead>
                                <tbody>
                                    ${filtered.map(e => `
                                        <tr style="border-bottom: 1px solid #fde68a;">
                                            <td style="padding: 8px; color: #9ca3af;">${e.rowNumber || ''}</td>
                                            <td style="padding: 8px;">${e.keyword}</td>
                                            <td style="padding: 8px;">${e.asin}</td>
                                            <td style="padding: 8px; color: #92400e;" title="${e.reason}">${e.reason.includes('Missing Keyword') ? 'No keyword' : e.reason.includes('Missing ASIN') ? 'No ASIN' : e.reason.includes('Campaign Paused') ? 'Campaign Paused' : e.reason.includes('Keyword Paused') ? 'Keyword Paused' : e.reason}</td>
                                        </tr>
                                    `).join('')}
                                </tbody>
                            </table>
                            <p style="font-size: 12px; color: #78350f; margin-top: 8px;">Total filtered: ${filtered.length} rows (${((filtered.length / this.totalUploadedRows) * 100).toFixed(1)}% of upload)</p>
                        `;
                    } else {
                        document.getElementById('filteredTable').innerHTML = '<p style="color: #9ca3af; font-style: italic;">No rows were filtered</p>';
                    }

                    // Render Chapter 3: Skipped Keywords
                    if (skipped.length > 0) {
                        document.getElementById('skippedTable').innerHTML = `
                            <table style="width: 100%; font-size: 13px; border-collapse: collapse;">
                                <thead>
                                    <tr style="background: #fef9c3; text-align: left;">
                                        <th style="padding: 8px; width: 60px;">Row #</th>
                                        <th style="padding: 8px;">Keyword</th>
                                        <th style="padding: 8px;">ASIN</th>
                                        <th style="padding: 8px; width: 100px;">Match Type</th>
                                        <th style="padding: 8px; width: 120px;">Sales Data</th>
                                    </tr>
                                </thead>
                                <tbody>
                                    ${skipped.slice(0, 50).map(e => `
                                        <tr style="border-bottom: 1px solid #fde047;">
                                            <td style="padding: 8px; color: #9ca3af;">${e.rowNumber || ''}</td>
                                            <td style="padding: 8px;">${e.keyword}</td>
                                            <td style="padding: 8px;">${e.asin}</td>
                                            <td style="padding: 8px;">${e.matchType}</td>
                                            <td style="padding: 8px; color: #a16207;" title="${e.reason}">${e.reason.includes('Empty') ? 'Empty field' : '$0.00'}</td>
                                        </tr>
                                    `).join('')}
                                    ${skipped.length > 50 ? `<tr><td colspan="5" style="padding: 12px; text-align: center; color: #9ca3af; font-style: italic;">Showing first 50 of ${skipped.length} rows</td></tr>` : ''}
                                </tbody>
                            </table>
                            <p style="font-size: 12px; color: #a16207; margin-top: 8px;">Total skipped: ${skipped.length} rows (${((skipped.length / this.totalUploadedRows) * 100).toFixed(1)}% of upload)</p>
                        `;
                    } else {
                        document.getElementById('skippedTable').innerHTML = '<p style="color: #9ca3af; font-style: italic;">No keywords were skipped</p>';
                    }

                    // Render Chapter 4: Analysis & Grouping
                    const scoringInfo = info.find(e => e.keyword === '📊 SCORING SETUP');
                    let analysisHTML = '<div>';

                    if (scoringInfo) {
                        analysisHTML += `
                            <div style="background: #eff6ff; padding: 12px; border-radius: 6px; margin-bottom: 12px; border: 1px solid #bfdbfe;">
                                <div style="font-weight: 600; color: #1e40af; margin-bottom: 4px;">Step 1: Score Calculation</div>
                                <div style="font-size: 12px; color: #1e3a8a;">${scoringInfo.reason}</div>
                            </div>
                        `;
                    }

                    if (parsed.length > 0) {
                        analysisHTML += `
                            <div style="background: #f5f3ff; padding: 12px; border-radius: 6px; border: 1px solid #ddd6fe;">
                                <div style="font-weight: 600; color: #5b21b6; margin-bottom: 8px;">Step 2: Campaign Parsing</div>
                                <table style="width: 100%; font-size: 12px; border-collapse: collapse;">
                                    <thead>
                                        <tr style="background: #ede9fe; text-align: left;">
                                            <th style="padding: 6px; width: 60px;">Row #</th>
                                            <th style="padding: 6px;">Keyword</th>
                                            <th style="padding: 6px;">Campaign</th>
                                            <th style="padding: 6px; width: 200px;">Extracted Info</th>
                                        </tr>
                                    </thead>
                                    <tbody>
                                        ${parsed.slice(0, 10).map(e => {
                            const shortCampaign = e.reason.match(/Campaign: "([^"]+)"/)?.[1] || '';
                            // Extract product, type, and match for cleaner display
                            const productMatch = e.reason.match(/Product: "([^"]+)"/);
                            const typeMatch = e.reason.match(/Type: ([^\|]+)/);
                            const matchTypeMatch = e.reason.match(/Match: (\w+)/);

                            const product = productMatch ? productMatch[1] : '';
                            const type = typeMatch ? typeMatch[1].trim() : '';
                            const matchType = matchTypeMatch ? matchTypeMatch[1] : '';

                            const cleanInfo = `${product} • ${type} • ${matchType}`;

                            return `
                                                \u003ctr style="border-bottom: 1px solid #ddd6fe;">
                                                    \u003ctd style="padding: 6px; color: #9ca3af;">${e.rowNumber || ''}\u003c/td>
                                                    \u003ctd style="padding: 6px;">${e.keyword}\u003c/td>
                                                    \u003ctd style="padding: 6px;" title="${shortCampaign}">${shortCampaign}\u003c/td>
                                                    \u003ctd style="padding: 6px; font-size: 11px; color: #4b5563;">${cleanInfo}\u003c/td>
                                                \u003c/tr>
                                            `;
                        }).join('')}
                                        ${parsed.length > 10 ? `<tr><td colspan="4" style="padding: 8px; text-align: center; color: #9ca3af; font-style: italic;">Showing first 10 of ${parsed.length} parsed keywords</td></tr>` : ''}
                                    </tbody>
                                </table>
                            </div>
                        `;
                    }

                    analysisHTML += '</div>';
                    document.getElementById('analysisDetails').innerHTML = analysisHTML || '<p style="color: #9ca3af; font-style: italic;">No analysis data available</p>';

                    // Render Chapter 5: Final Decisions
                    if (this.duplicates && Object.keys(this.duplicates).length > 0) {
                        let decisionsHTML = '';
                        let groupNum = 0;

                        for (const [groupKey, group] of Object.entries(this.duplicates)) {
                            if (groupNum >= 5) {
                                decisionsHTML += `<p style="text-align: center; color: #9ca3af; font-style: italic; margin-top: 12px;">Showing first 5 of ${Object.keys(this.duplicates).length} duplicate groups</p>`;
                                break;
                            }

                            groupNum++;
                            const paused = group.filter(k => k.recommendation === 'remove');
                            const kept = group.filter(k => k.recommendation === 'keep');

                            decisionsHTML += `
                                <div style="background: #f0fdf4; padding: 12px; border-radius: 6px; margin-bottom: 12px; border: 1px solid #86efac;">
                                    <div style="font-weight: 600; color: #15803d; margin-bottom: 8px;">Group ${groupNum}: "${group[0].name}" (${group.length} keywords)</div>
                                    <table style="width: 100%; font-size: 12px; border-collapse: collapse;">
                                        <thead>
                                            <tr style="background: #dcfce7; text-align: left;">
                                                <th style="padding: 6px; width: 60px;">Row #</th>
                                                <th style="padding: 6px;">Campaign</th>
                                                <th style="padding: 6px; width: 80px;">Score</th>
                                                <th style="padding: 6px; width: 100px;">Decision</th>
                                                <th style="padding: 6px;">Why?</th>
                                            </tr>
                                        </thead>
                                        <tbody>
                                            ${group.map(k => {
                                const isKeep = k.recommendation === 'keep';
                                const reason = isKeep ? 'Top score' : `Lower (${k.compositeScore} vs ${kept[0]?.compositeScore || 'N/A'})`;
                                return `
                                                    <tr style="border-bottom: 1px solid #86efac;">
                                                        <td style="padding: 6px; color: #9ca3af;">${k.rowNumber || ''}</td>
                                                        <td style="padding: 6px;" title="${k.campaign}">${k.campaign}</td>
                                                        <td style="padding: 6px; font-weight: 600;">${k.compositeScore}</td>
                                                        <td style="padding: 6px;">
                                                            <span style="background: ${isKeep ? '#dcfce7' : '#fef2f2'}; color: ${isKeep ? '#15803d' : '#dc2626'}; padding: 2px 6px; border-radius: 3px; font-size: 11px; font-weight: 600;">${isKeep ? '✅ KEEP' : '🔴 PAUSE'}</span>
                                                        </td>
                                                        <td style="padding: 6px; color: #6b7280; font-size: 11px;" title="${reason}">${reason}</td>
                                                    </tr>
                                                `;
                            }).join('')}
                                        </tbody>
                                    </table>
                                </div>
                            `;
                        }

                        decisionsHTML += `<p style="font-size: 12px; color: #15803d; font-weight: 600; margin-top: 12px;">Summary: ${decisions.filter(d => d.decision === 'PAUSE').length} keywords to pause, ${this.results.length - decisions.filter(d => d.decision === 'PAUSE').length} unique keywords to keep</p>`;
                        document.getElementById('decisionsTable').innerHTML = decisionsHTML;
                    } else {
                        document.getElementById('decisionsTable').innerHTML = '<p style="color: #9ca3af; font-style: italic;">No duplicate groups found</p>';
                    }
                }

                exportDebugLog() {
                    if (!this.debugLog || this.debugLog.length === 0) {
                        alert('No debug data to export');
                        return;
                    }

                    const csvContent = [
                        ['Keyword', 'ASIN', 'Match Type', 'Decision', 'Reason'].join(','),
                        ...this.debugLog.map(entry => [
                            `"${entry.keyword}"`,
                            `"${entry.asin}"`,
                            `"${entry.matchType}"`,
                            `"${entry.decision}"`,
                            `"${entry.reason}"`
                        ].join(','))
                    ].join('\n');

                    const blob = new Blob([csvContent], { type: 'text/csv' });
                    const url = URL.createObjectURL(blob);
                    const a = document.createElement('a');
                    a.href = url;
                    const timestamp = new Date().toISOString().slice(0, 10).replace(/-/g, '');
                    a.download = `debug_log_${timestamp}.csv`;
                    a.click();
                    URL.revokeObjectURL(url);
                }
            }

            let calculator;
            document.addEventListener('DOMContentLoaded', () => {
                calculator = new KeywordCalculator();
            });
        </script>
</body>

</html>